# GABAY Production Deployment Guide
**Target URL:** https://localhost/gabay

## Pre-Deployment Checklist

### ✅ Code Changes Made
All localhost references have been updated to use dynamic URL detection with production fallback:

1. **Database Configuration** (`connect_db.php`)
   - Uses dynamic environment detection
   - Fallback to localhost for local development
   - Ready for production credentials

2. **QR Code Systems**
   - Office QR: `generate_qrcodes.php` - Dynamic URL detection
   - Panorama QR: `panorama_api.php`, `panorama_qr_api.php` - Dynamic URL detection
   - Door QR: `door_qr_api.php` - Dynamic URL detection

3. **Password Reset** (`forgot_password.php`)
   - Uses dynamic host detection for reset links
   - Will generate proper HTTPS URLs in production

4. **Session Security** (`auth_guard.php`)
   - Auto-detects HTTPS for secure cookies
   - Supports proxy headers (X-Forwarded-Proto)

## Step-by-Step Deployment

### 1. Prepare Database on InfinityFree

#### A. Create MySQL Database
1. Log in to InfinityFree Control Panel (cPanel)
2. Go to **MySQL Databases**
3. Create a new database (e.g., `epiz_12345678_gabay`)
4. Create a database user with strong password
5. Assign user to database with ALL PRIVILEGES
6. **Note down these credentials:**
   ```
   Database Host: sql12345.infinityfreeapp.com (or similar)
   Database Name: epiz_12345678_gabay
   Database User: epiz_12345678
   Database Password: [your secure password]
   ```

#### B. Import Database Schema
1. Open **phpMyAdmin** from cPanel
2. Select your database
3. Go to **Import** tab
4. Upload `admin (14).sql` (or your latest SQL export)
5. Click **Go** to import
6. Verify tables are created successfully

**Important:** After import, you need to regenerate QR codes for production URLs (see Step 5)

### 2. Update Database Configuration

Edit `connect_db.php` with your production credentials:

```php
<?php
// Production/Development Database Configuration

if ($_SERVER['HTTP_HOST'] === 'localhost') {
    // Production settings
    $db_host = "sql12345.infinityfreeapp.com"; // Your InfinityFree MySQL host
    $db_name = "epiz_12345678_gabay"; // Your production database name
    $db_username = "epiz_12345678"; // Your production username
    $db_password = "your_secure_password"; // Your production password
} else {
    // Local development settings
    $db_host = "localhost";
    $db_name = "admin";
    $db_username = "root";
    $db_password = "";
}

try {
    $connect = new PDO("mysql:host=$db_host;dbname=$db_name", $db_username, $db_password);
    $connect->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    die("Connection failed: " . $e->getMessage());
}
?>
```

### 3. Upload Files to InfinityFree

#### A. Prepare Files for Upload
**Files to EXCLUDE** (do NOT upload):
- `connect_db.php.bak` (backup files)
- `*.log` (log files)
- `logs/` directory (will be recreated automatically)
- `.git/` (if using Git locally)
- `admin (*.sql)` (database exports - not needed on server)
- `check_*.php` (debugging files)
- `fix_*.php` (migration scripts - only run if needed)

#### B. Upload Methods

**Option 1: File Manager (Recommended for InfinityFree)**
1. Go to cPanel → **File Manager**
2. Navigate to `htdocs/` directory
3. Create `gabay/` folder
4. Upload all project files into `htdocs/gabay/`
5. Ensure proper folder structure:
   ```
   htdocs/
   └── gabay/
       ├── mobileScreen/
       ├── SVG/
       ├── Pano/
       ├── QR/
       ├── *.php files
       └── ... (all other folders)
   ```

**Option 2: FTP Client (FileZilla)**
1. Download FileZilla (https://filezilla-project.org/)
2. Get FTP credentials from InfinityFree cPanel
3. Connect to: `ftpupload.net` (or your FTP host)
4. Upload entire `gabay/` folder to `htdocs/`
5. Verify all files uploaded successfully

### 4. Set File Permissions

**Critical Directories** (need write permissions):
```
htdocs/gabay/QR/                    → 755 (rwxr-xr-x)
htdocs/gabay/Pano/                  → 755 (rwxr-xr-x)
htdocs/gabay/logs/                  → 755 (rwxr-xr-x)
htdocs/gabay/animated_hotspot_icons/ → 755 (rwxr-xr-x)
```

**PHP Files:** 644 (rw-r--r--)
**Folders:** 755 (rwxr-xr-x)

**How to Set Permissions in cPanel:**
1. File Manager → Right-click folder/file
2. Select **Change Permissions**
3. Set appropriate permissions
4. Apply to subfolders if needed

### 5. Regenerate QR Codes for Production

**IMPORTANT:** Old QR codes contain localhost/IP URLs. You must regenerate them:

#### A. Office QR Codes
1. Access: `https://localhost/gabay/generate_qrcodes.php`
2. This will regenerate all office QR codes with production URLs
3. QR codes saved to `QR/` directory
4. Verify QRs are generated by checking `QR/` folder

#### B. Panorama QR Codes
1. Access: `https://localhost/gabay/panorama_qr_manager.php`
2. Or use: `https://localhost/gabay/regenerate_all_panorama_qr.php`
3. Verify panorama QRs in database are updated

#### C. Door QR Codes
1. Go to Admin Panel → Floor Plans
2. For each floor, regenerate door QRs if needed
3. Or access: `https://localhost/gabay/generate_all_door_qrs.php`

### 6. Create Admin Account

If importing fresh database without admin account:

1. Access phpMyAdmin
2. Go to `admin` table
3. Run this SQL to create admin user:

```sql
INSERT INTO `admin` (`username`, `email`, `password`) 
VALUES (
    'admin_user', 
    'admin@gabay.gov.ph', 
    '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi'
);
```

**Default credentials:**
- Username: `admin_user`
- Password: `password`

**⚠️ CHANGE THIS PASSWORD IMMEDIATELY AFTER FIRST LOGIN!**

### 7. Test Critical Features

#### A. Admin Login
1. Go to: `https://localhost/gabay/login.php`
2. Log in with admin credentials
3. Verify redirect to dashboard works

#### B. Mobile Interface
1. Open on mobile: `https://localhost/gabay/mobileScreen/explore.php`
2. Test geofencing (if enabled)
3. Test office search
4. Test panorama viewer

#### C. QR Code Scanning
1. Scan an office QR code
2. Verify it opens explore.php with correct office
3. Test panorama QR code
4. Test door QR code

#### D. Password Reset
1. Log out
2. Click "Forgot Password?"
3. Enter username
4. Check email for reset link
5. Verify link has correct domain

#### E. System Settings
1. Go to System Settings
2. Test changing username/email
3. Test changing password
4. Test geofence toggle

### 8. Production Optimizations

#### A. PHP Configuration (if accessible via php.ini)
```ini
display_errors = Off
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT
log_errors = On
error_log = /path/to/logs/php_errors.log
max_execution_time = 300
memory_limit = 256M
upload_max_filesize = 50M
post_max_size = 50M
```

#### B. Enable HTTPS Redirect (Create .htaccess in root)
```apache
# Force HTTPS
RewriteEngine On
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Prevent directory listing
Options -Indexes

# Protect sensitive files
<FilesMatch "^(connect_db\.php|auth_guard\.php|.*\.sql)$">
    Order allow,deny
    Deny from all
</FilesMatch>
```

#### C. Security Headers (add to .htaccess)
```apache
# Security Headers
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>
```

### 9. Post-Deployment Monitoring

#### A. Check Error Logs
- Location: `logs/security.log`
- Monitor for authentication issues
- Check for database connection errors

#### B. Test from Multiple Devices
- Desktop browser (Chrome, Firefox, Edge)
- Mobile browser (iOS Safari, Android Chrome)
- Different network connections

#### C. Performance Testing
- Page load times
- QR code generation speed
- Mobile responsiveness
- SVG floor plan rendering

### 10. Maintenance Tasks

#### Regular Backups
**Database:**
- Weekly export from phpMyAdmin
- Download and store securely

**Files:**
- Monthly download of QR/, Pano/, logs/
- Keep versioned backups

#### Updates
- Monitor `logs/security.log` for suspicious activity
- Test new features on local development first
- Use version control (Git) for code changes

## Troubleshooting Common Issues

### Issue: "Connection failed: Access denied"
**Solution:** Double-check database credentials in `connect_db.php`

### Issue: "Session expired" immediately after login
**Solution:** Check session cookie settings, ensure cookies enabled in browser

### Issue: QR codes show old localhost URLs
**Solution:** Regenerate all QR codes using scripts in Step 5

### Issue: Images/SVG not loading
**Solution:** 
1. Check file permissions (755 for folders, 644 for files)
2. Verify paths are correct (case-sensitive on Linux)
3. Check if files uploaded correctly

### Issue: Password reset email not sending
**Solution:**
1. Configure SMTP in `forgot_password.php`
2. Check PHPMailer settings
3. Verify email server allows SMTP from your domain

### Issue: Geofencing not working
**Solution:**
1. HTTPS required for geolocation API
2. User must grant location permissions
3. Check coordinates in System Settings

### Issue: 500 Internal Server Error
**Solution:**
1. Check PHP error logs
2. Verify all files uploaded completely
3. Check file permissions
4. Look for syntax errors in PHP files

## Rollback Plan

If deployment fails:

1. **Restore Database:**
   - Import your pre-deployment SQL backup in phpMyAdmin

2. **Revert Files:**
   - Delete uploaded files
   - Re-upload previous working version

3. **Clear Cache:**
   - Clear browser cache
   - Clear PHP opcache if accessible

## Security Checklist Post-Deployment

- [ ] Changed default admin password
- [ ] Database credentials are secure
- [ ] HTTPS is enforced (no HTTP access)
- [ ] Session cookies are secure
- [ ] Error display is turned OFF
- [ ] Directory listing is disabled
- [ ] Sensitive files (.sql, .log) are protected
- [ ] File upload directories have proper permissions
- [ ] Regular backups are scheduled
- [ ] Security logs are monitored

## Support & Resources

- **InfinityFree Support:** https://forum.infinityfree.com/
- **PHP Documentation:** https://www.php.net/manual/
- **Project Documentation:** See `.md` files in project root

## Quick Reference Commands

**Regenerate Office QR Codes:**
```
https://localhost/gabay/generate_qrcodes.php
```

**Regenerate Panorama QR Codes:**
```
https://localhost/gabay/regenerate_all_panorama_qr.php
```

**Check Database Connection:**
```php
<?php
include 'connect_db.php';
echo "Database connected successfully!";
?>
```

---

**Deployment Date:** [Fill in after deployment]  
**Deployed By:** [Your name]  
**Production URL:** https://localhost/gabay  
**Database:** [Your production database name]

## Post-Deployment Notes

[Add any notes about specific issues encountered and how they were resolved]
