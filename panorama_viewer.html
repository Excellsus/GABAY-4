<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Panorama Hotspot Editor - GABAY Admin</title>

    <!-- A-Frame for VR/360 content -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

    <!-- Enhanced Animated Hotspots System -->
    <script src="aframe-animated-hotspots.js"></script>

    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #1a1a1a;
        color: white;
        overflow: hidden;
      }

      .editor-container {
        width: 100vw;
        height: 100vh;
        position: relative;
        display: flex;
        flex-direction: row;
      }

      .panorama-viewer {
        flex: 1;
        height: 100%;
        position: relative;
      }

      .toolbar {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        max-width: 280px;
      }

      .toolbar h3 {
        margin-bottom: 15px;
        color: #04aa6d;
        font-size: 18px;
      }

      .toolbar-section {
        margin-bottom: 15px;
      }

      .toolbar-section label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        color: #ccc;
      }

      .btn {
        background: #04aa6d;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        margin: 3px;
        font-size: 12px;
        transition: background 0.2s;
        width: 100%;
      }

      .btn:hover {
        background: #036551;
      }

      .btn-danger {
        background: #dc3545;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .input-field {
        width: 100%;
        max-width: 200px;
        padding: 6px;
        border: 1px solid #555;
        border-radius: 5px;
        background: #333;
        color: white;
        font-size: 12px;
      }

      .hotspot-list {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.8);
        padding: 15px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        max-width: 300px;
        max-height: 70vh;
        overflow-y: auto;
      }

      /* Tablet and small desktop responsive styles */
      @media (max-width: 1200px) and (min-width: 769px) {
        .toolbar {
          max-width: 250px;
          padding: 12px;
        }

        .hotspot-list {
          max-width: 250px;
          padding: 12px;
        }

        .btn {
          font-size: 11px;
          padding: 6px 10px;
        }

        .input-field {
          font-size: 11px;
        }
      }

      /* Mobile and tablet responsive styles */
      @media (max-width: 1024px) {
        .editor-container {
          position: relative;
          height: 100vh;
          overflow: hidden;
        }

        .panorama-viewer {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 40vh;
          z-index: 1;
          overflow: hidden;
        }

        .panorama-viewer a-scene {
          height: 40vh !important;
          width: 100% !important;
        }

        .toolbar {
          position: absolute;
          top: 40vh;
          left: 0;
          width: 100%;
          height: 30vh;
          overflow-y: auto;
          margin: 0;
          border-radius: 0;
          background: rgba(0, 0, 0, 0.8);
          backdrop-filter: blur(10px);
          padding: 15px;
        }

        .hotspot-list {
          position: absolute;
          top: 70vh;
          left: 0;
          width: 100%;
          height: 30vh;
          overflow-y: auto;
          margin: 0;
          border-radius: 0;
          background: rgba(0, 0, 0, 0.8);
          backdrop-filter: blur(10px);
          padding: 15px;
        }

        .toolbar h3 {
          font-size: 16px;
          margin-bottom: 10px;
        }

        .btn {
          padding: 6px 10px;
          font-size: 11px;
          margin: 2px;
        }

        .input-field {
          padding: 5px;
          font-size: 11px;
        }

        .toolbar-section {
          margin-bottom: 10px;
        }
      }

      @media (max-width: 768px) {
        .panorama-viewer {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 40vh;
          overflow: hidden;
        }

        .panorama-viewer a-scene {
          height: 40vh !important;
          width: 100% !important;
          display: block !important;
        }

        .toolbar {
          position: absolute;
          top: 40vh;
          left: 0;
          width: 100%;
          height: 35vh;
          padding: 10px;
        }

        .hotspot-list {
          position: absolute;
          top: 75vh;
          left: 0;
          width: 100%;
          height: 25vh;
          padding: 10px;
        }

        .toolbar h3 {
          font-size: 14px;
          margin-bottom: 8px;
        }

        .btn {
          padding: 5px 8px;
          font-size: 10px;
          margin: 1px;
        }

        .input-field {
          padding: 4px;
          font-size: 10px;
        }
      }

      @media (max-width: 480px) {
        .editor-container {
          position: relative;
          height: 100vh;
          overflow: hidden;
        }

        .panorama-viewer {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 35vh;
          overflow: hidden;
          z-index: 1;
        }

        .panorama-viewer a-scene {
          height: 35vh !important;
          width: 100% !important;
          display: block !important;
        }

        .toolbar {
          position: absolute;
          top: 35vh;
          left: 0;
          width: 100%;
          height: 40vh;
          padding: 8px;
        }

        .hotspot-list {
          position: absolute;
          top: 75vh;
          left: 0;
          width: 100%;
          height: 25vh;
          padding: 8px;
        }

        .toolbar h3 {
          font-size: 13px;
          margin-bottom: 6px;
        }

        .btn {
          padding: 4px 6px;
          font-size: 9px;
        }

        .input-field {
          padding: 3px;
          font-size: 9px;
        }

        .toolbar-section {
          margin-bottom: 8px;
        }

        .toolbar-section label {
          font-size: 11px;
          margin-bottom: 3px;
        }
      }

      .hotspot-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        border-left: 4px solid #04aa6d;
      }

      .hotspot-item.selected {
        border-left-color: #ffd700;
        background: rgba(255, 215, 0, 0.2);
      }

      .hotspot-item h4 {
        margin-bottom: 5px;
        font-size: 14px;
      }

      .hotspot-item p {
        font-size: 12px;
        color: #ccc;
      }

      .hotspot-actions {
        margin-top: 10px;
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
      }

      .hotspot-actions button {
        font-size: 12px;
        padding: 5px 10px;
        flex: 1;
        min-width: 60px;
      }

      /* Mobile responsive styles for hotspot items */
      @media (max-width: 1024px) {
        .hotspot-item {
          padding: 8px;
          margin: 8px 0;
        }

        .hotspot-item h4 {
          font-size: 12px;
          margin-bottom: 4px;
        }

        .hotspot-item p {
          font-size: 10px;
        }

        .hotspot-actions {
          margin-top: 8px;
          gap: 3px;
        }

        .hotspot-actions button {
          font-size: 10px;
          padding: 4px 8px;
          min-width: 50px;
        }
      }

      @media (max-width: 768px) {
        .hotspot-item {
          padding: 6px;
          margin: 6px 0;
        }

        .hotspot-item h4 {
          font-size: 11px;
          margin-bottom: 3px;
        }

        .hotspot-item p {
          font-size: 9px;
        }

        .hotspot-actions button {
          font-size: 9px;
          padding: 3px 6px;
          min-width: 45px;
        }
      }

      @media (max-width: 480px) {
        .hotspot-item {
          padding: 5px;
          margin: 5px 0;
        }

        .hotspot-item h4 {
          font-size: 10px;
          margin-bottom: 2px;
        }

        .hotspot-item p {
          font-size: 8px;
        }

        .hotspot-actions {
          margin-top: 6px;
        }

        .hotspot-actions button {
          font-size: 8px;
          padding: 2px 5px;
          min-width: 40px;
        }
      }

      .status-bar {
        position: absolute;
        bottom: 20px;
        left: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px 20px;
        border-radius: 5px;
        text-align: center;
        font-size: 14px;
      }

      .instructions {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px 20px;
        border-radius: 5px;
        text-align: center;
        font-size: 12px;
        color: #ccc;
      }

      /* Mobile responsive styles for status bar and instructions */
      @media (max-width: 1024px) {
        .status-bar {
          position: relative;
          bottom: auto;
          left: auto;
          right: auto;
          margin: 5px;
          font-size: 12px;
          padding: 8px 15px;
        }

        .instructions {
          position: relative;
          bottom: auto;
          left: auto;
          transform: none;
          margin: 5px;
          font-size: 10px;
          padding: 8px 15px;
        }
      }

      @media (max-width: 768px) {
        .status-bar {
          font-size: 11px;
          padding: 6px 12px;
          margin: 3px;
        }

        .instructions {
          font-size: 9px;
          padding: 6px 12px;
          margin: 3px;
        }
      }

      @media (max-width: 480px) {
        .status-bar {
          font-size: 10px;
          padding: 5px 10px;
          margin: 2px;
        }

        .instructions {
          font-size: 8px;
          padding: 5px 10px;
          margin: 2px;
        }
      }

      /* Custom hotspot styles for A-Frame */
      .hotspot-entity {
        cursor: pointer;
      }

      /* Loading overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        flex-direction: column;
      }

      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #04aa6d;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Icon Selection Overlay */
      .icon-selection-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 3000;
      }

      .icon-selection-overlay.active {
        display: flex;
      }

      .icon-selection-panel {
        background: rgba(30, 30, 30, 0.95);
        border-radius: 15px;
        padding: 30px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        backdrop-filter: blur(10px);
        border: 2px solid #04aa6d;
        margin: 10px;
      }

      .icon-selection-header {
        text-align: center;
        margin-bottom: 25px;
      }

      .icon-selection-header h3 {
        color: #04aa6d;
        font-size: 22px;
        margin-bottom: 10px;
      }

      .icon-selection-header p {
        color: #ccc;
        font-size: 14px;
      }

      .icon-categories {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        gap: 10px;
        flex-wrap: wrap;
      }

      .category-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #555;
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .category-btn.active,
      .category-btn:hover {
        background: #04aa6d;
        border-color: #04aa6d;
      }

      .icons-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 15px;
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
      }

      /* Mobile responsive styles for icon selection */
      @media (max-width: 768px) {
        .icon-selection-panel {
          padding: 20px;
          max-width: 95vw;
          max-height: 90vh;
          margin: 5px;
        }

        .icon-selection-header h3 {
          font-size: 18px;
        }

        .icon-selection-header p {
          font-size: 12px;
        }

        .category-btn {
          padding: 6px 12px;
          font-size: 10px;
        }

        .icons-grid {
          grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
          gap: 10px;
          max-height: 300px;
          padding: 5px;
        }
      }

      @media (max-width: 480px) {
        .icon-selection-panel {
          padding: 15px;
          max-width: 98vw;
          max-height: 95vh;
          margin: 2px;
          border-radius: 10px;
        }

        .icon-selection-header {
          margin-bottom: 15px;
        }

        .icon-selection-header h3 {
          font-size: 16px;
          margin-bottom: 8px;
        }

        .icon-selection-header p {
          font-size: 11px;
        }

        .icon-categories {
          gap: 5px;
          margin-bottom: 15px;
        }

        .category-btn {
          padding: 4px 8px;
          font-size: 9px;
          border-radius: 15px;
        }

        .icons-grid {
          grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
          gap: 8px;
          max-height: 250px;
          padding: 3px;
        }
      }

      .icon-item {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid transparent;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .icon-item:hover {
        background: rgba(4, 170, 109, 0.2);
        border-color: #04aa6d;
        transform: scale(1.05);
      }

      .icon-item.selected {
        background: rgba(255, 215, 0, 0.2);
        border-color: #ffd700;
      }

      .icon-item i {
        font-size: 24px;
        margin-bottom: 8px;
        color: #04aa6d;
      }

      .icon-item.selected i {
        color: #ffd700;
      }

      .icon-item span {
        font-size: 11px;
        color: #ccc;
        text-align: center;
        line-height: 1.2;
      }

      /* Mobile responsive styles for icon items */
      @media (max-width: 768px) {
        .icon-item {
          padding: 10px;
          min-height: 60px;
        }

        .icon-item i {
          font-size: 20px;
          margin-bottom: 6px;
        }

        .icon-item span {
          font-size: 9px;
        }
      }

      @media (max-width: 480px) {
        .icon-item {
          padding: 8px;
          min-height: 50px;
          border-radius: 8px;
        }

        .icon-item i {
          font-size: 16px;
          margin-bottom: 4px;
        }

        .icon-item span {
          font-size: 8px;
          line-height: 1.1;
        }

        .icon-item:hover {
          transform: scale(1.02);
        }
      }

      .overlay-actions {
        margin-top: 25px;
        display: flex;
        justify-content: center;
        gap: 15px;
      }

      /* Draggable icon cursor */
      .dragging-icon {
        position: fixed;
        pointer-events: none;
        z-index: 4000;
        font-size: 30px;
        color: #04aa6d;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        transform: translate(-50%, -50%);
      }

      /* Instructions when dragging */
      .drag-instructions {
        position: fixed;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: #04aa6d;
        padding: 15px 25px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: bold;
        z-index: 4000;
        border: 2px solid #04aa6d;
        display: none;
      }

      /* Hotspot Settings Controls */
      .hotspot-settings {
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        border: 2px solid #04aa6d;
        border-radius: 10px;
        padding: 20px;
        z-index: 5000;
        color: white;
        font-family: Arial, sans-serif;
        min-width: 280px;
        max-width: 90vw;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
      }

      /* Mobile responsive styles for hotspot settings */
      @media (max-width: 768px) {
        .hotspot-settings {
          padding: 15px;
          min-width: 250px;
          max-width: 95vw;
          border-radius: 8px;
        }
      }

      @media (max-width: 480px) {
        .hotspot-settings {
          padding: 12px;
          min-width: 200px;
          max-width: 98vw;
          border-radius: 6px;
          font-size: 12px;
        }

        .settings-header h4 {
          font-size: 14px;
        }

        .control-group label {
          font-size: 11px;
        }

        .control-btn {
          padding: 6px 10px;
          font-size: 10px;
        }
      }

      .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #333;
      }

      .settings-header h4 {
        margin: 0;
        color: #04aa6d;
        font-size: 16px;
      }

      .close-settings {
        background: none;
        border: none;
        color: #ccc;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .close-settings:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .control-group {
        margin-bottom: 15px;
      }

      .control-group label {
        display: block;
        font-size: 12px;
        color: #ccc;
        margin-bottom: 8px;
        font-weight: bold;
      }

      .control-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .control-slider {
        flex: 1;
        height: 6px;
        background: #333;
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
      }

      .control-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: #04aa6d;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      .control-slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: #04aa6d;
        border-radius: 50%;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      .control-value {
        width: 50px;
        text-align: center;
        font-size: 12px;
        color: #04aa6d;
        font-weight: bold;
      }

      .reset-controls {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #333;
        display: flex;
        gap: 10px;
      }

      .control-btn {
        background: #04aa6d;
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        flex: 1;
      }

      .control-btn:hover {
        background: #036551;
      }

      .control-btn.danger {
        background: #dc3545;
      }

      .control-btn.danger:hover {
        background: #c82333;
      }

      /* A-Frame scene optimizations */
      a-scene {
        width: 100%;
        height: 100%;
        touch-action: none;
      }

      /* Mobile touch optimization for A-Frame */
      @media (max-width: 1024px) {
        a-scene {
          height: 100% !important;
          width: 100% !important;
          display: block !important;
          position: relative !important;
        }

        a-scene canvas {
          width: 100% !important;
          height: 100% !important;
          touch-action: pan-x pan-y;
          display: block !important;
          position: absolute !important;
          top: 0 !important;
          left: 0 !important;
        }

        /* Ensure panorama canvas fills the container properly */
        .panorama-viewer canvas {
          object-fit: cover !important;
        }
      }

      /* Prevent scrolling on mobile */
      @media (max-width: 1024px) {
        html,
        body {
          margin: 0 !important;
          padding: 0 !important;
          overflow: hidden;
          position: fixed;
          width: 100%;
          height: 100%;
        }

        .editor-container {
          margin: 0 !important;
          padding: 0 !important;
        }
      }

      /* Touch-friendly drag instructions */
      @media (max-width: 1024px) {
        .drag-instructions {
          font-size: 14px;
          padding: 12px 20px;
          bottom: 30px;
        }
      }

      @media (max-width: 480px) {
        .drag-instructions {
          font-size: 12px;
          padding: 10px 15px;
          bottom: 20px;
        }
      }

      /* Professional Mobile UI Improvements */

      /* Enhanced Mobile Navigation Bar */
      .mobile-nav-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: linear-gradient(135deg, #04aa6d 0%, #036551 100%);
        display: none;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        z-index: 10000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
      }

      .mobile-nav-bar h2 {
        color: white;
        font-size: 16px;
        font-weight: 600;
        margin: 0;
        flex: 1;
        text-align: center;
      }

      .nav-menu-btn,
      .nav-close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .nav-menu-btn:hover,
      .nav-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      /* Professional Mobile Bottom Sheet */
      .mobile-bottom-sheet {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, #1a1a1a 0%, #2d2d2d 100%);
        border-radius: 20px 20px 0 0;
        transform: translateY(calc(100% - 60px));
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        z-index: 9999;
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.5);
        max-height: 70vh;
        overflow: hidden;
      }

      .mobile-bottom-sheet.expanded {
        transform: translateY(0);
      }

      .sheet-handle {
        width: 40px;
        height: 5px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        margin: 10px auto;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .sheet-handle:hover {
        background: rgba(255, 255, 255, 0.5);
      }

      .sheet-header {
        padding: 10px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .sheet-title {
        color: #04aa6d;
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }

      .sheet-content {
        padding: 0;
        max-height: calc(70vh - 100px);
        overflow-y: auto;
      }

      /* Professional Tab System */
      .mobile-tabs {
        display: flex;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        margin: 15px;
        padding: 4px;
      }

      .tab-btn {
        flex: 1;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        padding: 12px 8px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .tab-btn.active {
        background: #04aa6d;
        color: white;
        transform: scale(1.02);
      }

      .tab-btn i {
        font-size: 16px;
      }

      .tab-content {
        display: none;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Enhanced Form Controls */
      .form-group-mobile {
        margin-bottom: 20px;
      }

      .form-label-mobile {
        display: block;
        color: #04aa6d;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .form-input-mobile {
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 12px 16px;
        color: white;
        font-size: 16px;
        transition: all 0.3s ease;
        box-sizing: border-box;
      }

      .form-input-mobile:focus {
        outline: none;
        border-color: #04aa6d;
        background: rgba(255, 255, 255, 0.15);
        transform: scale(1.02);
      }

      .form-select-mobile {
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 12px 16px;
        color: white;
        font-size: 16px;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 16px center;
        background-size: 16px;
        cursor: pointer;
        box-sizing: border-box;
      }

      /* Professional Button Styles */
      .btn-mobile-primary {
        background: linear-gradient(135deg, #04aa6d 0%, #036551 100%);
        border: none;
        color: white;
        padding: 14px 24px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(4, 170, 109, 0.3);
        box-sizing: border-box;
      }

      .btn-mobile-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(4, 170, 109, 0.4);
      }

      .btn-mobile-secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        width: 100%;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-sizing: border-box;
      }

      .btn-mobile-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .btn-mobile-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        box-sizing: border-box;
      }

      .btn-mobile-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
      }

      /* Professional Hotspot Cards */
      .hotspot-card-mobile {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0.05) 100%
        );
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .hotspot-card-mobile::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #04aa6d 0%, #036551 100%);
      }

      .hotspot-card-mobile.selected::before {
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
      }

      .hotspot-card-mobile:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        border-color: rgba(4, 170, 109, 0.5);
      }

      .hotspot-header-mobile {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .hotspot-title-mobile {
        color: white;
        font-size: 16px;
        font-weight: 600;
        margin: 0;
        flex: 1;
      }

      .hotspot-type-badge {
        background: rgba(4, 170, 109, 0.2);
        color: #04aa6d;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid rgba(4, 170, 109, 0.3);
      }

      .hotspot-description-mobile {
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        line-height: 1.4;
        margin-bottom: 16px;
      }

      .hotspot-actions-mobile {
        display: flex;
        gap: 10px;
      }

      .hotspot-actions-mobile .btn-mobile-secondary {
        margin-bottom: 0;
        padding: 8px 16px;
        font-size: 12px;
        flex: 1;
      }

      /* Professional Status Indicators */
      .status-indicator {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        z-index: 9998;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: none;
        align-items: center;
        gap: 8px;
      }

      .status-indicator.success {
        background: rgba(40, 167, 69, 0.9);
        border-color: rgba(40, 167, 69, 0.5);
      }

      .status-indicator.error {
        background: rgba(220, 53, 69, 0.9);
        border-color: rgba(220, 53, 69, 0.5);
      }

      .status-indicator.warning {
        background: rgba(255, 193, 7, 0.9);
        border-color: rgba(255, 193, 7, 0.5);
        color: #000;
      }

      /* Professional Loading States */
      .loading-overlay-mobile {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        backdrop-filter: blur(10px);
      }

      .loading-spinner-mobile {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top: 4px solid #04aa6d;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      .loading-text-mobile {
        color: white;
        font-size: 16px;
        font-weight: 500;
        text-align: center;
        margin-bottom: 10px;
      }

      .loading-subtext-mobile {
        color: rgba(255, 255, 255, 0.7);
        font-size: 14px;
        text-align: center;
      }

      /* Professional Panorama Controls */
      .panorama-controls-mobile {
        position: absolute;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 1001;
      }

      .control-btn-mobile {
        width: 50px;
        height: 50px;
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
      }

      .control-btn-mobile:hover {
        background: rgba(4, 170, 109, 0.8);
        border-color: #04aa6d;
        transform: scale(1.1);
      }

      /* Mobile Toggle Button */
      .mobile-toggle-btn {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 9999;
        background: rgba(4, 170, 109, 0.9);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .mobile-toggle-btn:hover {
        background: rgba(4, 170, 109, 1);
      }

      /* Professional Help/Tutorial Overlay */
      .help-overlay-mobile {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10002;
        padding: 20px;
      }

      .help-content-mobile {
        background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
        border-radius: 20px;
        padding: 30px;
        max-width: 400px;
        width: 100%;
        border: 2px solid rgba(4, 170, 109, 0.3);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        max-height: 90vh;
        overflow-y: auto;
      }

      .help-header-mobile {
        text-align: center;
        margin-bottom: 25px;
      }

      .help-title-mobile {
        color: #04aa6d;
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .help-subtitle-mobile {
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
      }

      .help-steps-mobile {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .help-step-mobile {
        display: flex;
        align-items: flex-start;
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border-left: 4px solid #04aa6d;
      }

      .step-number-mobile {
        background: #04aa6d;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        margin-right: 12px;
        flex-shrink: 0;
      }

      .step-text-mobile {
        color: white;
        font-size: 14px;
        line-height: 1.4;
      }

      /* Professional Animations */
      @keyframes slideUpFromBottom {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes bounceIn {
        0% {
          transform: scale(0.3);
          opacity: 0;
        }
        50% {
          transform: scale(1.05);
        }
        70% {
          transform: scale(0.9);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(4, 170, 109, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(4, 170, 109, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(4, 170, 109, 0);
        }
      }

      @media (max-width: 1024px) {
        .mobile-toggle-btn {
          display: block !important;
        }

        .mobile-nav-bar {
          display: flex;
        }

        .panorama-viewer {
          margin-top: 60px;
        }

        .toolbar,
        .hotspot-list {
          display: none;
        }

        .instructions {
          display: none;
        }
      }

      /* Mobile View States */
      .mobile-view .toolbar {
        transform: translateY(100vh);
        transition: transform 0.3s ease;
      }

      .mobile-view .hotspot-list {
        transform: translateY(100vh);
        transition: transform 0.3s ease;
      }

      .mobile-view .panorama-viewer {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100vh !important;
        z-index: 10 !important;
      }

      /* Hide instructions on mobile to prevent interference */
      @media (max-width: 1024px) {
        .instructions {
          display: none;
        }
      }

      /* Ensure panorama is always at top on mobile */
      @media (max-width: 1024px) {
        body {
          padding: 0;
          margin: 0;
        }

        .panorama-viewer {
          position: relative !important;
          top: 0 !important;
          margin-top: 0 !important;
        }

        /* Mobile scroll behavior - panorama stays at top */
        .editor-container {
          scroll-behavior: smooth;
        }

        /* Ensure mobile toolbar doesn't push panorama down */
        .toolbar {
          position: static !important;
        }

        .hotspot-list {
          position: static !important;
        }
      }

      /* Show panels in mobile */
      .mobile-panels-visible .toolbar {
        transform: translateY(0);
      }

      .mobile-panels-visible .hotspot-list {
        transform: translateX(0);
      }

      /* Landscape mobile optimization */
      @media (max-width: 1024px) and (orientation: landscape) {
        .editor-container {
          flex-direction: row;
        }

        .panorama-viewer {
          height: 100vh;
          width: 60%;
          order: 1;
        }

        .toolbar {
          position: relative;
          width: 20%;
          height: 100vh;
          order: 2;
        }

        .hotspot-list {
          position: relative;
          width: 20%;
          height: 100vh;
          order: 3;
        }

        /* In mobile view, hide panels completely in landscape */
        .mobile-view .toolbar {
          width: 0;
          overflow: hidden;
        }

        .mobile-view .hotspot-list {
          width: 0;
          overflow: hidden;
        }

        .mobile-view .panorama-viewer {
          width: 100%;
        }
      }

      /* Split screen laptop mode */
      @media (min-width: 1025px) and (max-width: 1366px) {
        .toolbar {
          max-width: 220px;
          padding: 10px;
        }

        .hotspot-list {
          max-width: 220px;
          padding: 10px;
        }

        .toolbar h3 {
          font-size: 16px;
        }

        .btn {
          font-size: 11px;
          padding: 6px 10px;
        }
      }

      /* Animated Icons Manager Styles */
      .animated-icons-tabs {
        display: flex;
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 4px;
      }

      .animated-tab-btn {
        flex: 1;
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
      }

      .animated-tab-btn.active {
        background: #04aa6d;
        color: white;
      }

      .animated-tab-btn:hover {
        background: rgba(4, 170, 109, 0.7);
        color: white;
      }

      .animated-tab-content {
        display: block;
      }

      .animated-filter-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #555;
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
      }

      .animated-filter-btn.active,
      .animated-filter-btn:hover {
        background: #04aa6d;
        border-color: #04aa6d;
      }

      .animated-icon-card {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .animated-icon-card:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: #04aa6d;
        transform: translateY(-2px);
      }

      .animated-icon-preview {
        width: 60px;
        height: 60px;
        margin: 0 auto 10px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #04aa6d;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #333;
      }

      .animated-icon-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .animated-icon-name {
        color: white;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 5px;
        word-break: break-word;
      }

      .animated-icon-category {
        background: rgba(4, 170, 109, 0.2);
        color: #04aa6d;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        display: inline-block;
        margin-bottom: 8px;
      }

      .animated-icon-actions {
        display: flex;
        gap: 5px;
        justify-content: center;
      }

      .animated-icon-actions button {
        padding: 4px 8px;
        font-size: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .animated-icon-actions .btn {
        padding: 4px 8px;
        font-size: 10px;
      }

      .animated-message {
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid #04aa6d;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.4s ease;
      }

      .animated-message.show {
        opacity: 1;
        transform: translateX(0);
      }

      .animated-message.success {
        border-left-color: #28a745;
      }

      .animated-message.error {
        border-left-color: #dc3545;
      }

      .animated-message.warning {
        border-left-color: #ffc107;
      }

      /* File drop zone styles */
      #animated-file-drop-zone:hover {
        border-color: #04aa6d;
        background: rgba(4, 170, 109, 0.1);
      }

      #animated-file-drop-zone.dragover {
        border-color: #04aa6d;
        background: rgba(4, 170, 109, 0.2);
      }

      /* Mobile responsive for animated icons manager */
      @media (max-width: 768px) {
        .animated-icons-tabs {
          flex-direction: column;
          gap: 4px;
        }

        .animated-tab-btn {
          text-align: center;
        }

        #animated-icons-grid {
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
          gap: 10px;
        }

        .animated-icon-card {
          padding: 10px;
        }

        .animated-icon-preview {
          width: 50px;
          height: 50px;
        }
      }

      /* Animated GIF Overlay Styles */
      .gif-hotspot-overlay {
        position: fixed;
        pointer-events: none;
        z-index: 1000;
        border-radius: 8px;
        transition: transform 0.2s ease, opacity 0.2s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .gif-hotspot-overlay:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(4, 170, 109, 0.4);
        border-color: #04aa6d;
      }

      /* Animation for when GIF overlays appear */
      @keyframes gifFadeIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .gif-hotspot-overlay {
        animation: gifFadeIn 0.3s ease-out;
      }
    </style>
  </head>
  <body>
    <!-- Professional Mobile Navigation Bar -->
    <div class="mobile-nav-bar" id="mobile-nav-bar">
      <button class="nav-menu-btn" onclick="toggleMobileBottomSheet()">
        <i class="fas fa-bars"></i>
      </button>
      <h2>Panorama Editor</h2>
      <button class="nav-close-btn" onclick="showHelpOverlay()">
        <i class="fas fa-question-circle"></i>
      </button>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
      <div class="spinner"></div>
      <p>Loading panorama editor...</p>
    </div>

    <!-- Icon Selection Overlay -->
    <div
      id="icon-selection-overlay"
      class="icon-selection-overlay"
      style="display: none"
    >
      <div class="icon-selection-panel">
        <div class="icon-selection-header">
          <h3>Choose Hotspot Icon</h3>
          <p>Select an icon type, then drag and drop it onto the panorama</p>
        </div>

        <div class="icon-categories">
          <button class="category-btn active" data-category="all">All</button>
          <button class="category-btn" data-category="info">Information</button>
          <button class="category-btn" data-category="navigation">
            Navigation
          </button>
          <button class="category-btn" data-category="office">Offices</button>
          <button class="category-btn" data-category="services">
            Services
          </button>
          <button class="category-btn" data-category="facilities">
            Facilities
          </button>
        </div>

        <div class="icons-grid" id="icons-grid">
          <!-- Icons will be populated by JavaScript -->
        </div>

        <div class="overlay-actions">
          <button
            id="manage-animated-icons-btn"
            class="btn"
            style="background: #17a2b8"
          >
            <i class="fas fa-video"></i> Add Video Hotspot
          </button>
          <button id="cancel-icon-selection" class="btn btn-secondary">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Animated Hotspot Icons Manager Modal -->
    <div
      id="animated-icons-modal"
      class="icon-selection-overlay"
      style="display: none"
    >
      <div class="icon-selection-panel" style="max-width: 900px">
        <div class="icon-selection-header">
          <h3><i class="fas fa-video"></i> Video Hotspot Manager</h3>
          <p>Upload and manage MP4 videos for animated panorama hotspots</p>
        </div>

        <!-- Upload Tab (Hidden) -->
        <div id="upload-tab" class="animated-tab-content" style="display: none">
          <form
            id="animated-icon-upload-form"
            enctype="multipart/form-data"
            style="
              background: rgba(255, 255, 255, 0.05);
              padding: 20px;
              border-radius: 10px;
              margin-bottom: 20px;
            "
          >
            <div style="display: grid; gap: 15px">
              <div>
                <label
                  style="
                    display: block;
                    margin-bottom: 5px;
                    color: #04aa6d;
                    font-weight: 600;
                  "
                  >Icon Name *</label
                >
                <input
                  type="text"
                  id="animated-icon-name"
                  name="icon_name"
                  required
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #555;
                    border-radius: 5px;
                    background: #333;
                    color: white;
                  "
                  placeholder="Enter unique icon name"
                />
              </div>

              <div>
                <label
                  style="
                    display: block;
                    margin-bottom: 5px;
                    color: #04aa6d;
                    font-weight: 600;
                  "
                  >Description</label
                >
                <textarea
                  id="animated-icon-description"
                  name="icon_description"
                  rows="3"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #555;
                    border-radius: 5px;
                    background: #333;
                    color: white;
                    resize: vertical;
                  "
                  placeholder="Describe what this icon represents"
                ></textarea>
              </div>

              <div>
                <label
                  style="
                    display: block;
                    margin-bottom: 5px;
                    color: #04aa6d;
                    font-weight: 600;
                  "
                  >Category</label
                >
                <select
                  id="animated-icon-category"
                  name="icon_category"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #555;
                    border-radius: 5px;
                    background: #333;
                    color: white;
                  "
                >
                  <option value="info">Information</option>
                  <option value="navigation">Navigation</option>
                  <option value="office">Office</option>
                  <option value="services">Services</option>
                  <option value="facilities">Facilities</option>
                  <option value="general">General</option>
                </select>
              </div>

              <div>
                <label
                  style="
                    display: block;
                    margin-bottom: 5px;
                    color: #04aa6d;
                    font-weight: 600;
                  "
                  >Animated GIF File *</label
                >
                <div
                  style="
                    border: 2px dashed #555;
                    border-radius: 10px;
                    padding: 20px;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s;
                  "
                  id="animated-file-drop-zone"
                  onclick="document.getElementById('animated-icon-file').click()"
                >
                  <input
                    type="file"
                    id="animated-icon-file"
                    name="icon_file"
                    accept=".gif"
                    required
                    style="display: none"
                  />
                  <i
                    class="fas fa-cloud-upload-alt"
                    style="font-size: 30px; color: #04aa6d; margin-bottom: 10px"
                  ></i>
                  <div style="color: white; margin-bottom: 5px">
                    Click to select GIF file
                  </div>
                  <small style="color: #888">Maximum file size: 2MB</small>
                </div>
                <div
                  id="animated-file-preview"
                  style="display: none; text-align: center; margin-top: 15px"
                >
                  <img
                    id="animated-preview-image"
                    src=""
                    alt="Preview"
                    style="
                      max-width: 100px;
                      max-height: 100px;
                      border-radius: 10px;
                      border: 2px solid #04aa6d;
                    "
                  />
                  <p
                    id="animated-file-info"
                    style="margin-top: 8px; color: #ccc; font-size: 12px"
                  ></p>
                </div>
              </div>

              <div style="text-align: center">
                <button
                  type="submit"
                  class="btn"
                  style="padding: 12px 30px; font-size: 16px"
                >
                  <i class="fas fa-upload"></i> Upload Animated Icon
                </button>
              </div>
            </div>
          </form>
        </div>

        <!-- Video Hotspots Tab -->
        <div id="video-tab" class="animated-tab-content" style="display: block">
          <div
            style="
              background: rgba(255, 255, 255, 0.05);
              padding: 20px;
              border-radius: 10px;
              margin-bottom: 20px;
            "
          >
            <h4 style="color: #04aa6d; margin-bottom: 15px">
              <i class="fas fa-video"></i> MP4 Video Hotspots
            </h4>
            <p style="color: #ccc; margin-bottom: 20px">
              Create animated hotspots using MP4 videos for better A-Frame
              performance. Videos will play automatically and loop continuously.
            </p>

            <div style="display: flex; gap: 15px; margin-bottom: 20px">
              <button
                id="open-video-manager-btn"
                class="btn"
                style="background: #2196f3; padding: 10px 20px"
              >
                <i class="fas fa-folder-open"></i> Manage Videos
              </button>
              <button
                id="refresh-videos-btn"
                class="btn btn-secondary"
                style="padding: 10px 20px"
              >
                <i class="fas fa-sync"></i> Refresh
              </button>
            </div>

            <div
              id="video-hotspots-grid"
              style="
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
                max-height: 350px;
                overflow-y: auto;
                padding: 10px;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 8px;
              "
            >
              <div
                style="
                  text-align: center;
                  color: #888;
                  grid-column: 1/-1;
                  padding: 30px;
                "
              >
                <i
                  class="fas fa-spinner fa-spin"
                  style="font-size: 30px; margin-bottom: 10px"
                ></i>
                <div>Loading video hotspots...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Manage Tab (Hidden) -->
        <div id="manage-tab" class="animated-tab-content" style="display: none">
          <div style="margin-bottom: 20px">
            <div
              style="
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                flex-wrap: wrap;
              "
            >
              <button
                class="animated-filter-btn active"
                data-category="all"
                style="
                  background: rgba(255, 255, 255, 0.1);
                  border: 1px solid #555;
                  color: white;
                  padding: 6px 12px;
                  border-radius: 15px;
                  cursor: pointer;
                  font-size: 12px;
                "
              >
                All
              </button>
              <button class="animated-filter-btn" data-category="info">
                Information
              </button>
              <button class="animated-filter-btn" data-category="navigation">
                Navigation
              </button>
              <button class="animated-filter-btn" data-category="office">
                Office
              </button>
              <button class="animated-filter-btn" data-category="services">
                Services
              </button>
              <button class="animated-filter-btn" data-category="facilities">
                Facilities
              </button>
              <button class="animated-filter-btn" data-category="general">
                General
              </button>
            </div>
          </div>

          <div
            id="animated-icons-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
              gap: 15px;
              max-height: 400px;
              overflow-y: auto;
              padding: 10px;
            "
          >
            <div
              style="
                text-align: center;
                color: #888;
                grid-column: 1/-1;
                padding: 50px;
              "
            >
              <i
                class="fas fa-spinner fa-spin"
                style="font-size: 30px; margin-bottom: 10px"
              ></i>
              <div>Loading animated icons...</div>
            </div>
          </div>
        </div>

        <div class="overlay-actions">
          <button id="close-animated-icons-modal" class="btn btn-secondary">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Animated Icon Modal -->
    <div
      id="edit-animated-icon-modal"
      class="icon-selection-overlay"
      style="display: none"
    >
      <div class="icon-selection-panel" style="max-width: 500px">
        <div class="icon-selection-header">
          <h3>Edit Animated Icon</h3>
          <p>Update icon details</p>
        </div>

        <form
          id="edit-animated-icon-form"
          style="
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
          "
        >
          <input type="hidden" id="edit-animated-icon-id" name="icon_id" />

          <div style="display: grid; gap: 15px">
            <div>
              <label
                style="
                  display: block;
                  margin-bottom: 5px;
                  color: #04aa6d;
                  font-weight: 600;
                "
                >Icon Name *</label
              >
              <input
                type="text"
                id="edit-animated-icon-name"
                name="icon_name"
                required
                style="
                  width: 100%;
                  padding: 8px;
                  border: 1px solid #555;
                  border-radius: 5px;
                  background: #333;
                  color: white;
                "
              />
            </div>

            <div>
              <label
                style="
                  display: block;
                  margin-bottom: 5px;
                  color: #04aa6d;
                  font-weight: 600;
                "
                >Description</label
              >
              <textarea
                id="edit-animated-icon-description"
                name="icon_description"
                rows="3"
                style="
                  width: 100%;
                  padding: 8px;
                  border: 1px solid #555;
                  border-radius: 5px;
                  background: #333;
                  color: white;
                  resize: vertical;
                "
              ></textarea>
            </div>

            <div>
              <label
                style="
                  display: block;
                  margin-bottom: 5px;
                  color: #04aa6d;
                  font-weight: 600;
                "
                >Category</label
              >
              <select
                id="edit-animated-icon-category"
                name="icon_category"
                style="
                  width: 100%;
                  padding: 8px;
                  border: 1px solid #555;
                  border-radius: 5px;
                  background: #333;
                  color: white;
                "
              >
                <option value="info">Information</option>
                <option value="navigation">Navigation</option>
                <option value="office">Office</option>
                <option value="services">Services</option>
                <option value="facilities">Facilities</option>
                <option value="general">General</option>
              </select>
            </div>

            <div
              style="
                text-align: center;
                display: flex;
                gap: 10px;
                justify-content: center;
              "
            >
              <button
                type="button"
                id="cancel-edit-animated-icon"
                class="btn btn-secondary"
              >
                Cancel
              </button>
              <button type="submit" class="btn">
                <i class="fas fa-save"></i> Update Icon
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Messages Container for Animated Icons -->
    <div
      id="animated-icons-messages"
      style="position: fixed; top: 20px; right: 20px; z-index: 10000"
    ></div>

    <!-- Draggable Icon Element -->
    <div id="dragging-icon" class="dragging-icon" style="display: none">
      <i class="fas fa-info-circle"></i>
    </div>

    <!-- Drag Instructions -->
    <div id="drag-instructions" class="drag-instructions">
      Drop the icon anywhere on the panorama to place hotspot
    </div>

    <!-- Hotspot Settings Controls -->
    <div id="hotspot-settings" class="hotspot-settings" style="display: none">
      <div class="settings-header">
        <h4 id="settings-title">Hotspot Settings</h4>
        <button class="close-settings" onclick="editor.hideHotspotSettings()">
          
        </button>
      </div>

      <div class="control-group">
        <label>Horizontal Rotation</label>
        <div class="control-row">
          <input
            type="range"
            id="rotation-x"
            class="control-slider"
            min="-180"
            max="180"
            value="0"
            step="1"
          />
          <span class="control-value" id="rotation-x-value">0</span>
        </div>
      </div>

      <div class="control-group">
        <label>Vertical Rotation</label>
        <div class="control-row">
          <input
            type="range"
            id="rotation-y"
            class="control-slider"
            min="-180"
            max="180"
            value="0"
            step="1"
          />
          <span class="control-value" id="rotation-y-value">0</span>
        </div>
      </div>

      <div class="control-group">
        <label>Size</label>
        <div class="control-row">
          <input
            type="range"
            id="scale"
            class="control-slider"
            min="0.5"
            max="3"
            value="1"
            step="0.1"
          />
          <span class="control-value" id="scale-value">1.0x</span>
        </div>
      </div>

      <div class="reset-controls">
        <button class="control-btn" onclick="editor.resetHotspotTransform()">
          Reset
        </button>
        <button
          class="control-btn"
          onclick="editor.selectHotspot(editor.currentSettingsHotspot)"
        >
          Edit Info
        </button>
        <button
          class="control-btn"
          onclick="editor.saveCurrentHotspotTransform()"
          style="background: #28a745"
        >
           Save
        </button>
        <button
          class="control-btn"
          onclick="editor.validateTransformPersistence()"
          style="background: #17a2b8"
        >
           Test
        </button>
        <button
          class="control-btn danger"
          onclick="editor.deleteCurrentHotspot()"
        >
          Delete
        </button>
      </div>
    </div>

    <div class="editor-container">
      <!-- Mobile Toggle Button -->
      <button
        id="mobile-toggle-btn"
        class="mobile-toggle-btn"
        style="display: none"
        onclick="toggleMobileView()"
      >
        <span id="toggle-text"> Switch to Mobile View</span>
      </button>

      <!-- Toolbar -->
      <div class="toolbar" id="toolbar">
        <h3>Hotspot Editor</h3>

        <div class="toolbar-section">
          <button id="add-hotspot-btn" class="btn"> Add Video Hotspot</button>
          <button id="test-hotspot-btn" class="btn" style="background: orange">
             Test Hotspot
          </button>
          <button id="save-hotspots-btn" class="btn"> Save All</button>
        </div>

        <div class="toolbar-section">
          <label>Hotspot Title:</label>
          <input
            type="text"
            id="hotspot-title"
            class="input-field"
            placeholder="Enter title..."
          />
        </div>

        <div class="toolbar-section">
          <label>Description:</label>
          <input
            type="text"
            id="hotspot-description"
            class="input-field"
            placeholder="Enter description..."
          />
        </div>

        <div class="toolbar-section">
          <label>Hotspot Type:</label>
          <select id="hotspot-type" class="input-field">
            <option value="info">Information Only</option>
            <option value="navigation">Navigate to Another View</option>
            <option value="office">Office Link</option>
            <option value="external">External URL</option>
          </select>
        </div>

        <div
          class="toolbar-section"
          id="navigation-section"
          style="
            display: none;
            border: 2px solid #ffa500;
            border-radius: 8px;
            padding: 12px;
            background: rgba(255, 165, 0, 0.1);
          "
        >
          <label
            style="
              color: #ffa500;
              font-weight: bold;
              display: flex;
              align-items: center;
              gap: 5px;
            "
          >
             Navigation Configuration:
          </label>
          <p style="font-size: 11px; color: #ccc; margin: 5px 0">
            Select a panorama point to navigate to when this hotspot is clicked:
          </p>
          <select
            id="navigation-target"
            class="input-field"
            style="border: 1px solid #ffa500; background: #2a2a2a"
          >
            <option value="">Select panorama...</option>
          </select>
          <button
            id="refresh-targets"
            class="btn"
            style="
              margin-top: 8px;
              font-size: 12px;
              background: #ffa500;
              color: #000;
              font-weight: bold;
            "
          >
             Refresh Panorama List
          </button>
          <div
            id="navigation-preview"
            style="
              margin-top: 8px;
              padding: 6px;
              background: rgba(0, 0, 0, 0.3);
              border-radius: 4px;
              font-size: 10px;
              color: #aaa;
              display: none;
            "
          >
            <strong>Selected:</strong>
            <span id="navigation-preview-text"></span>
          </div>
        </div>

        <div class="toolbar-section" id="external-section">
          <label>Link Target:</label>
          <input
            type="text"
            id="hotspot-target"
            class="input-field"
            placeholder="URL or office ID..."
          />
        </div>

        <div class="toolbar-section">
          <button id="update-hotspot-btn" class="btn" style="display: none">
            Update Selected
          </button>
          <button
            id="delete-hotspot-btn"
            class="btn btn-danger"
            style="display: none"
          >
            Delete Selected
          </button>
        </div>

        <div class="toolbar-section">
          <button id="close-editor-btn" class="btn btn-secondary">
            Close Editor
          </button>
        </div>
      </div>

      <!-- Hotspot List -->
      <div class="hotspot-list">
        <h3>Hotspots</h3>
        <div id="hotspot-list-container">
          <p style="color: #888; text-align: center">No hotspots added yet</p>
        </div>
      </div>

      <!-- A-Frame Panorama Scene -->
      <div class="panorama-viewer">
        <a-scene
          id="panorama-scene"
          mouse-wheel="fovMin: 30; fovMax: 100;"
          touch-zoom
          embedded
          animated-hotspot-manager
          style="height: 100%; width: 100%"
        >
          <!-- Assets - Preloaded animated GIF textures -->
          <a-assets id="panorama-assets" timeout="10000">
            <!-- Animated hotspot assets will be dynamically loaded here -->
          </a-assets>

          <!-- Camera with look controls and raycaster for interaction -->
          <a-entity
            id="camera-rig"
            camera
            look-controls="pointerLockEnabled: false"
            wasd-controls-enabled="false"
            cursor="rayOrigin: mouse; fuse: false;"
            raycaster="objects: .raycastable; far: 50; interval: 100;"
          >
          </a-entity>

          <!-- Sky element for panorama image -->
          <a-sky id="panorama-sky" src=""></a-sky>

          <!-- Hotspots container -->
          <a-entity id="hotspots-container"></a-entity>

          <!-- Lighting for better hotspot visibility -->
          <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
          <a-light
            type="point"
            position="0 5 0"
            color="#ffffff"
            intensity="0.3"
          ></a-light>
        </a-scene>
      </div>

      <!-- Instructions -->
      <div class="instructions">
        Click anywhere in the panorama to add a hotspot  Drag hotspots to
        reposition  Click hotspots to edit
      </div>

      <!-- Professional Panorama Controls -->
      <div class="panorama-controls-mobile" id="panorama-controls">
        <button
          class="control-btn-mobile"
          onclick="resetPanoramaView()"
          title="Reset View"
        >
          <i class="fas fa-home"></i>
        </button>
        <button
          class="control-btn-mobile"
          onclick="toggleFullscreen()"
          title="Fullscreen"
        >
          <i class="fas fa-expand"></i>
        </button>
      </div>
    </div>

    <!-- Professional Status Indicator -->
    <div class="status-indicator" id="status-indicator">
      <i class="fas fa-info-circle"></i>
      <span id="status-text">Ready</span>
    </div>

    <!-- Professional Loading Overlay for Mobile -->
    <div
      class="loading-overlay-mobile"
      id="loading-overlay-mobile"
      style="display: none"
    >
      <div class="loading-spinner-mobile"></div>
      <div class="loading-text-mobile">Processing...</div>
      <div class="loading-subtext-mobile">
        Please wait while we save your changes
      </div>
    </div>

    <!-- Professional Help/Tutorial Overlay -->
    <div class="help-overlay-mobile" id="help-overlay">
      <div class="help-content-mobile">
        <div class="help-header-mobile">
          <h3 class="help-title-mobile">How to Use</h3>
          <p class="help-subtitle-mobile">Quick guide to panorama editing</p>
        </div>

        <ol class="help-steps-mobile">
          <li class="help-step-mobile">
            <div class="step-number-mobile">1</div>
            <div class="step-text-mobile">
              <strong>Add Hotspots:</strong> Tap the "Add New Hotspot" button
              and select an icon, then tap anywhere on the panorama to place it.
            </div>
          </li>
          <li class="help-step-mobile">
            <div class="step-number-mobile">2</div>
            <div class="step-text-mobile">
              <strong>Edit Hotspots:</strong> Tap any hotspot in the panorama to
              open its settings and customize position, size, and rotation.
            </div>
          </li>
          <li class="help-step-mobile">
            <div class="step-number-mobile">3</div>
            <div class="step-text-mobile">
              <strong>Move Around:</strong> Drag on the panorama to look around.
              Pinch to zoom in/out.
            </div>
          </li>
          <li class="help-step-mobile">
            <div class="step-number-mobile">4</div>
            <div class="step-text-mobile">
              <strong>Save Changes:</strong> Don't forget to tap "Save All
              Changes" to keep your hotspots.
            </div>
          </li>
        </ol>

        <div class="form-group-mobile">
          <button class="btn-mobile-primary" onclick="hideHelpOverlay()">
            <i class="fas fa-check"></i>
            Got It!
          </button>
        </div>
      </div>
    </div>

    <script>
      class PanoramaHotspotEditor {
        constructor() {
          this.hotspots = [];
          this.selectedHotspot = null;
          this.panoramaImage = null;
          this.pathId = null;
          this.pointIndex = null;
          this.floor = null;
          this.isAddingMode = false;
          this.selectedIcon = null;
          this.isDraggingIcon = false;
          this.availablePanoramas = [];
          this.currentSettingsHotspot = null;

          // Bind event handlers for proper removal
          this.boundDragMove = this.onIconDragMove.bind(this);
          this.boundDragClick = this.onIconDragClick.bind(this);

          // Available icons organized by category
          this.iconLibrary = {
            info: [
              { icon: "fas fa-info-circle", name: "Information", type: "info" },
              { icon: "fas fa-question-circle", name: "Help", type: "info" },
              {
                icon: "fas fa-exclamation-triangle",
                name: "Warning",
                type: "info",
              },
              { icon: "fas fa-lightbulb", name: "Tip", type: "info" },
              { icon: "fas fa-book", name: "Guide", type: "info" },
            ],
            navigation: [
              { icon: "fas fa-arrow-up", name: "Go Up", type: "navigation" },
              {
                icon: "fas fa-arrow-down",
                name: "Go Down",
                type: "navigation",
              },
              {
                icon: "fas fa-arrow-left",
                name: "Go Left",
                type: "navigation",
              },
              {
                icon: "fas fa-arrow-right",
                name: "Go Right",
                type: "navigation",
              },
              { icon: "fas fa-compass", name: "Direction", type: "navigation" },
              {
                icon: "fas fa-map-marker-alt",
                name: "Location",
                type: "navigation",
              },
              {
                icon: "fas fa-route",
                name: "Path",
                type: "navigation",
              },
              {
                icon: "fas fa-door-open",
                name: "Enter",
                type: "navigation",
              },
            ],
            office: [
              { icon: "fas fa-building", name: "Office", type: "office" },
              { icon: "fas fa-user-tie", name: "Manager", type: "office" },
              { icon: "fas fa-users", name: "Department", type: "office" },
              { icon: "fas fa-briefcase", name: "Business", type: "office" },
              { icon: "fas fa-desk", name: "Workspace", type: "office" },
            ],
            services: [
              {
                icon: "fas fa-concierge-bell",
                name: "Service",
                type: "services",
              },
              { icon: "fas fa-phone", name: "Contact", type: "services" },
              { icon: "fas fa-envelope", name: "Mail", type: "services" },
              { icon: "fas fa-calendar", name: "Schedule", type: "services" },
              {
                icon: "fas fa-clipboard-check",
                name: "Forms",
                type: "services",
              },
            ],
            facilities: [
              { icon: "fas fa-restroom", name: "Restroom", type: "facilities" },
              { icon: "fas fa-elevator", name: "Elevator", type: "facilities" },
              { icon: "fas fa-stairs", name: "Stairs", type: "facilities" },
              { icon: "fas fa-coffee", name: "Cafe", type: "facilities" },
              { icon: "fas fa-parking", name: "Parking", type: "facilities" },
              {
                icon: "fas fa-wheelchair",
                name: "Accessible",
                type: "facilities",
              },
            ],
          };

          this.init();
        }

        init() {
          // Parse URL parameters
          this.parseURLParams();

          // Initialize A-Frame scene
          this.initScene();

          // Initialize icon selection
          this.initIconSelection();

          // Bind event listeners
          this.bindEvents();

          // Wait for scene to be ready before loading hotspots
          this.waitForSceneReady().then(() => {
            console.log(" Scene is ready, loading existing hotspots...");
            // Load existing hotspots after scene is ready
            this.loadHotspots();
            // Load available panoramas for navigation
            this.loadAvailablePanoramas();
          });

          // Hide loading overlay
          setTimeout(() => {
            document.getElementById("loading-overlay").style.display = "none";
          }, 2000);
        }

        // Wait for A-Frame scene to be fully ready
        waitForSceneReady() {
          return new Promise((resolve) => {
            const scene = document.getElementById("panorama-scene");
            const hotspotsContainer =
              document.getElementById("hotspots-container");

            if (scene && scene.hasLoaded && hotspotsContainer) {
              console.log(" Scene already loaded and ready");
              resolve();
            } else {
              console.log(" Waiting for scene to load...");
              const checkReady = () => {
                const scene = document.getElementById("panorama-scene");
                const hotspotsContainer =
                  document.getElementById("hotspots-container");

                if (scene && scene.hasLoaded && hotspotsContainer) {
                  console.log(" Scene now ready");
                  resolve();
                } else {
                  setTimeout(checkReady, 200);
                }
              };

              // Also listen for scene loaded event
              if (scene) {
                scene.addEventListener("loaded", () => {
                  console.log(" Scene loaded event fired");
                  setTimeout(resolve, 500); // Small delay to ensure everything is ready
                });
              }

              checkReady();
            }
          });
        }

        parseURLParams() {
          const urlParams = new URLSearchParams(window.location.search);
          this.panoramaImage = urlParams.get("image");
          this.pathId = urlParams.get("pathId");
          this.pointIndex = urlParams.get("pointIndex");
          this.floor = urlParams.get("floor");

          console.log("Editor params:", {
            image: this.panoramaImage,
            pathId: this.pathId,
            pointIndex: this.pointIndex,
            floor: this.floor,
          });
        }

        initScene() {
          const scene = document.getElementById("panorama-scene");
          const sky = document.getElementById("panorama-sky");

          if (this.panoramaImage) {
            sky.setAttribute("src", this.panoramaImage);
          } else {
            console.error("No panorama image specified");
            alert("Error: No panorama image specified");
            return;
          }

          // Wait for A-Frame to load
          scene.addEventListener("loaded", () => {
            console.log("A-Frame scene loaded");
            this.setupClickToAdd();
            // Start billboard updates after scene loads
            setTimeout(() => {
              this.startBillboardUpdates();
            }, 1000);
          });
        }

        setupClickToAdd() {
          const sky = document.getElementById("panorama-sky");
          const scene = document.getElementById("panorama-scene");

          // Add click listener to sky
          sky.addEventListener("click", (event) => {
            console.log("Sky clicked! isAddingMode:", this.isAddingMode);
            console.log("Event detail:", event.detail);

            if (!this.isAddingMode) {
              console.log("Not in adding mode, ignoring click");
              return;
            }

            const intersection = event.detail.intersection;
            console.log("Intersection:", intersection);

            if (intersection && intersection.point) {
              console.log("Adding hotspot at position:", intersection.point);
              this.addHotspotAtPosition(intersection.point);
              this.isAddingMode = false;
              const btn = document.getElementById("add-hotspot-btn");
              if (btn) {
                btn.textContent = " Add Video Hotspot";
                btn.style.background = "#04aa6d";
              }
            } else {
              console.log("No valid intersection point");
            }
          });

          // Also add click listener to the entire scene as fallback
          if (scene) {
            scene.addEventListener("click", (event) => {
              console.log("Scene clicked! isAddingMode:", this.isAddingMode);

              if (!this.isAddingMode) return;

              // Create a default position if no intersection
              const defaultPosition = { x: 0, y: 0, z: -2 };
              console.log(
                "Adding hotspot at default position:",
                defaultPosition
              );

              this.addHotspotAtPosition(defaultPosition);
              this.isAddingMode = false;
              const btn = document.getElementById("add-hotspot-btn");
              if (btn) {
                btn.textContent = " Add Video Hotspot";
                btn.style.background = "#04aa6d";
              }
            });
          }
        }

        addHotspotAtPosition(position) {
          const hotspotId = "hotspot_" + Date.now();

          const hotspot = {
            id: hotspotId,
            position: position,
            title:
              document.getElementById("hotspot-title").value ||
              (window.selectedAnimatedIcon
                ? `Animated: ${window.selectedAnimatedIcon.name}`
                : "Untitled Hotspot"),
            description:
              document.getElementById("hotspot-description").value ||
              (window.selectedAnimatedIcon
                ? `Animated hotspot using ${window.selectedAnimatedIcon.name}`
                : ""),
            type: document.getElementById("hotspot-type").value,
            target: document.getElementById("hotspot-target").value || "",
            created: new Date().toISOString(),
          };

          // Add animated icon data if selected
          if (window.selectedAnimatedIcon) {
            console.log(
              " Adding animated icon data:",
              window.selectedAnimatedIcon
            );

            hotspot.animated_icon_id = window.selectedAnimatedIcon.id;
            // Normalize path to a web-accessible URL when possible
            const rawPath =
              window.selectedAnimatedIcon.path ||
              window.selectedAnimatedIcon.icon_file_path;
            try {
              hotspot.animated_icon_path =
                (typeof normalizeAssetUrl === 'function'
                  ? normalizeAssetUrl(rawPath)
                  : rawPath) || rawPath;
            } catch (e) {
              hotspot.animated_icon_path = rawPath;
            }
            hotspot.animated_icon_name =
              window.selectedAnimatedIcon.name ||
              window.selectedAnimatedIcon.icon_name;

            // Set default size for animated hotspots
            hotspot.scale = { x: 1.2, y: 1.2, z: 1.2 };

            console.log(" Hotspot with animated icon created:", hotspot);

            // Clear the selection
            window.selectedAnimatedIcon = null;
          }

          // Add video hotspot data if selected
          if (window.selectedVideoHotspot) {
            console.log(
              " Adding video hotspot data:",
              window.selectedVideoHotspot
            );

            hotspot.video_hotspot_id = window.selectedVideoHotspot.id;
            hotspot.video_hotspot_path = window.selectedVideoHotspot.url;
            hotspot.video_hotspot_name = window.selectedVideoHotspot.name;
            hotspot.video_duration = window.selectedVideoHotspot.duration;
            hotspot.video_dimensions = {
              width: window.selectedVideoHotspot.width,
              height: window.selectedVideoHotspot.height,
            };

            // Set default size for video hotspots
            hotspot.scale = { x: 1.0, y: 1.0, z: 1.0 };

            console.log(" Hotspot with video created:", hotspot);

            // Clear the selection
            window.selectedVideoHotspot = null;
          }

          // Hide instructions and reset button for both types
          if (window.selectedAnimatedIcon || window.selectedVideoHotspot) {
            const instructions = document.getElementById("drag-instructions");
            if (instructions) {
              instructions.style.display = "none";
            }

            const btn = document.getElementById("add-hotspot-btn");
            if (btn) {
              btn.textContent = " Add Video Hotspot";
              btn.style.background = "#04aa6d";
              btn.style.animation = "";
            }
          }

          this.hotspots.push(hotspot);
          const entity = this.createHotspotEntity(hotspot);

          // Auto-select the new hotspot for editing if it's animated
          if (hotspot.animated_icon_id && entity) {
            setTimeout(() => {
              this.selectHotspot(hotspot);
              // Show success message
              this.showTemporaryMessage(
                ` Animated hotspot "${hotspot.title}" created successfully!`,
                "#28a745"
              );
            }, 500);
          }

          this.updateHotspotList();
          this.clearForm();
        }

        createHotspotEntity(hotspot) {
          console.log("Creating hotspot entity for:", hotspot);

          const scene = document.getElementById("panorama-scene");
          const hotspotsContainer =
            document.getElementById("hotspots-container");

          if (!hotspotsContainer || !scene) {
            console.error("Scene or hotspots container not found!");
            return;
          }

          // Check if this hotspot uses video
          if (hotspot.video_hotspot_path || hotspot.video_hotspot_id) {
            console.log(" Creating A-Frame video hotspot:", hotspot.title);

            // Use the new A-Frame video hotspots system
            const system = scene.systems["video-hotspot-manager"];
            if (system) {
              const videoConfig = {
                id: hotspot.id,
                videoUrl: hotspot.video_hotspot_path,
                position: `${hotspot.position.x} ${hotspot.position.y} ${hotspot.position.z}`,
                title: hotspot.title || "Video Hotspot",
                description: hotspot.description || "",
                type: hotspot.type || "info",
                width: hotspot.scale?.x || 1.0,
                height: hotspot.scale?.y || 1.0,
                interactive: true,
                autoPlay: true,
                loop: true,
                muted: true,
              };

              // Create the video hotspot using the system
              const hotspotEntity = system.createVideoHotspot(videoConfig);

              // Apply stored transform values if they exist
              if (hotspot.rotation) {
                hotspotEntity.removeAttribute("look-at");
                hotspotEntity.setAttribute(
                  "rotation",
                  `${hotspot.rotation.x} ${hotspot.rotation.y} ${hotspot.rotation.z}`
                );
              }

              if (hotspot.scale) {
                hotspotEntity.setAttribute(
                  "scale",
                  `${hotspot.scale.x} ${hotspot.scale.y} ${hotspot.scale.z}`
                );
              }

              // Make draggable for admin editing
              this.makeDraggable(hotspotEntity, hotspot);

              // Add admin click handler for settings
              hotspotEntity.addEventListener("click", (event) => {
                console.log(
                  " Video hotspot clicked for settings:",
                  hotspot.title
                );
                event.stopPropagation();
                event.preventDefault();
                this.showHotspotSettings(hotspot);
              });

              console.log(" A-Frame video hotspot created:", hotspot.title);
              return hotspotEntity;
            } else {
              console.warn(
                " Video hotspot system not available, falling back to standard hotspot"
              );
            }
          }

          // Check if this hotspot uses animated GIF
          if (hotspot.animated_icon_path || hotspot.animated_icon_id) {
            console.log(" Creating A-Frame animated hotspot:", hotspot.title);

            // Use the new A-Frame animated hotspots system (if available)
            const system = scene.systems["animated-hotspot-manager"];
            if (system && system.createAnimatedHotspot) {
              const animatedConfig = {
                id: hotspot.id,
                assetId: hotspot.animated_icon_id,
                position: `${hotspot.position.x} ${hotspot.position.y} ${hotspot.position.z}`,
                title: hotspot.title || "Animated Hotspot",
                description: hotspot.description || "",
                type: hotspot.type || "info",
                width: hotspot.scale?.x || 0.8,
                height: hotspot.scale?.y || 0.8,
                interactive: true,
                autoScale: false, // Disable auto-scale for admin editing
                glowEffect: true,
              };

              // Create the animated hotspot using the system
              const hotspotEntity =
                system.createAnimatedHotspot(animatedConfig);

              // Apply stored transform values if they exist
              if (hotspot.rotation) {
                hotspotEntity.removeAttribute("look-at");
                hotspotEntity.setAttribute(
                  "rotation",
                  `${hotspot.rotation.x} ${hotspot.rotation.y} ${hotspot.rotation.z}`
                );
              }

              if (hotspot.scale) {
                hotspotEntity.setAttribute(
                  "scale",
                  `${hotspot.scale.x} ${hotspot.scale.y} ${hotspot.scale.z}`
                );
              }

              // Make draggable for admin editing
              this.makeDraggable(hotspotEntity, hotspot);

              // Add admin click handler for settings
              hotspotEntity.addEventListener("click", (event) => {
                console.log(
                  " Animated hotspot clicked for settings:",
                  hotspot.title
                );
                event.stopPropagation();
                event.preventDefault();
                this.showHotspotSettings(hotspot);
              });

              console.log(
                " A-Frame animated hotspot created:",
                hotspot.title
              );
              return hotspotEntity;
            } else {
              console.warn(
                " Animated hotspot system not available, falling back to legacy method"
              );
            }
          }

          // Legacy hotspot creation for non-animated or fallback cases
          const hotspotEntity = document.createElement("a-entity");
          hotspotEntity.setAttribute("id", hotspot.id);

          // Set position first
          hotspotEntity.setAttribute(
            "position",
            `${hotspot.position.x} ${hotspot.position.y} ${hotspot.position.z}`
          );

          // Determine hotspot appearance based on type
          const isNavigation =
            hotspot.type === "navigation" && hotspot.linkType === "panorama";
          const hotspotColor = isNavigation ? "#ffa500" : "#04aa6d";

          if (hotspot.icon) {
            // Create icon-based hotspot
            hotspotEntity.setAttribute(
              "geometry",
              "primitive: plane; width: 0.4; height: 0.4"
            );
            hotspotEntity.setAttribute(
              "material",
              `color: ${hotspotColor}; transparent: true; opacity: 0.9; side: double`
            );

            // Add icon as text
            const iconEntity = document.createElement("a-text");
            iconEntity.setAttribute(
              "value",
              this.getIconCharacter(hotspot.icon)
            );
            iconEntity.setAttribute("position", "0 0 0.01");
            iconEntity.setAttribute("align", "center");
            iconEntity.setAttribute("color", "white");
            iconEntity.setAttribute("scale", "3 3 3");
            hotspotEntity.appendChild(iconEntity);
          } else {
            // Default sphere hotspot
            hotspotEntity.setAttribute(
              "geometry",
              "primitive: plane; width: 0.3; height: 0.3"
            );
            hotspotEntity.setAttribute(
              "material",
              `color: ${hotspotColor}; emissive: ${hotspotColor}; emissiveIntensity: 0.5; side: double`
            );
          }

          // Add raycastable class for interaction
          hotspotEntity.setAttribute("class", "raycastable");

          hotspotEntity.setAttribute(
            "animation__hover",
            "property: scale; to: 1.3 1.3 1.3; startEvents: mouseenter; dur: 200"
          );
          hotspotEntity.setAttribute(
            "animation__leave",
            "property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
          );

          // Add visible text label
          const labelEntity = document.createElement("a-text");
          labelEntity.setAttribute("value", hotspot.title || "Hotspot");
          labelEntity.setAttribute("position", "0 -0.3 0");
          labelEntity.setAttribute("align", "center");
          labelEntity.setAttribute("color", "#ffff00");
          labelEntity.setAttribute("scale", "1.5 1.5 1.5");

          hotspotEntity.appendChild(labelEntity);

          // Apply stored transform values if they exist
          if (hotspot.rotation) {
            hotspotEntity.setAttribute(
              "rotation",
              `${hotspot.rotation.x} ${hotspot.rotation.y} ${hotspot.rotation.z}`
            );
          } else {
            // Add look-at component to face camera (billboard behavior) only if no custom rotation
            hotspotEntity.setAttribute("look-at", "[camera]");
          }

          if (hotspot.scale) {
            hotspotEntity.setAttribute(
              "scale",
              `${hotspot.scale.x} ${hotspot.scale.y} ${hotspot.scale.z}`
            );
          }

          // Make draggable
          this.makeDraggable(hotspotEntity, hotspot);

          // Add click handler for settings mode
          hotspotEntity.addEventListener("click", (event) => {
            console.log(
              " Hotspot clicked for settings:",
              hotspot.title,
              hotspot.type
            );
            event.stopPropagation();
            event.preventDefault();
            this.showHotspotSettings(hotspot);
          });

          // Add to scene
          hotspotsContainer.appendChild(hotspotEntity);

          console.log(" Hotspot entity added to scene:", {
            id: hotspot.id,
            title: hotspot.title,
            entity: hotspotEntity,
            parentContainer: hotspotsContainer,
          });

          // Verify the entity was actually added and is visible
          setTimeout(() => {
            const addedEntity = document.getElementById(hotspot.id);
            if (addedEntity) {
              console.log(" Hotspot entity verified in DOM:", hotspot.title);
            } else {
              console.error(
                " Hotspot entity not found in DOM:",
                hotspot.title
              );
            }
          }, 100);
          console.log(
            "Scene children count:",
            hotspotsContainer.children.length
          );

          return hotspotEntity;
        }

        // Method to create animated GIF overlays
        createAnimatedOverlay(hotspot, hotspotEntity) {
          try {
            // Normalize asset URL and add cache-busting
            const iconUrl = this.normalizeAssetUrl
              ? this.normalizeAssetUrl(hotspot.animated_icon_path)
              : (function (p) {
                  // fallback normalization
                  if (!p) return p;
                  p = String(p).replace(/\\\\/g, '/');
                  if (p.startsWith('http') || p.startsWith('/')) {
                    return p + (p.includes('?') ? '&' : '?') + 'v=' + Date.now();
                  }
                  return `animated_hotspot_icons/${p.split('/').pop()}?v=${Date.now()}`;
                })(hotspot.animated_icon_path);

            console.log(" Creating animated overlay for:", iconUrl);

            // Debug log final overlay URL
            console.log(' [overlay] hotspot', hotspot.id, 'using', iconUrl);

            // Create HTML overlay element
            const gifOverlay = document.createElement("img");
            gifOverlay.id = `gif-overlay-${hotspot.id}`;
            gifOverlay.src = iconUrl;
            gifOverlay.className = "animated-hotspot-overlay";

            // Style the overlay
            gifOverlay.style.cssText = `
              position: fixed;
              width: 60px;
              height: 60px;
              z-index: 10000;
              border-radius: 8px;
              border: 2px solid #ff6b6b;
              cursor: pointer;
              pointer-events: auto;
              display: none;
              box-shadow: 0 4px 12px rgba(0,0,0,0.3);
              background-color: rgba(255,255,255,0.1);
              transition: transform 0.2s ease;
            `;

            // Add hover effects
            gifOverlay.addEventListener("mouseenter", () => {
              gifOverlay.style.transform = "scale(1.15)";
              gifOverlay.style.borderColor = "#ff4444";
            });

            gifOverlay.addEventListener("mouseleave", () => {
              gifOverlay.style.transform = "scale(1)";
              gifOverlay.style.borderColor = "#ff6b6b";
            });

            // Add click handler
            gifOverlay.addEventListener("click", (event) => {
              event.stopPropagation();
              console.log("Animated GIF clicked:", hotspot.title);
              if (hotspot.type === "navigation" && hotspot.target) {
                window.location.href = hotspot.target;
              } else {
                alert(
                  `${hotspot.title}\n${hotspot.description || "No description"}`
                );
              }
            });

            // Handle load success
            gifOverlay.onload = () => {
              console.log(" Animated GIF loaded successfully:", iconUrl);
              document.body.appendChild(gifOverlay);

              // Start position tracking
              this.trackOverlayPosition(gifOverlay, hotspotEntity);
            };

            // Handle load error
            gifOverlay.onerror = () => {
              console.warn(" Failed to load animated GIF:", iconUrl);
              // Fallback: show error indicator on the hotspot
              const errorText = hotspotEntity.querySelector("a-text");
              if (errorText) {
                errorText.setAttribute("value", " GIF");
                errorText.setAttribute("color", "#ff4444");
              }
            };
          } catch (error) {
            console.error("Error creating animated overlay:", error);
          }
        }

        // Method to track overlay position relative to 3D hotspot
        trackOverlayPosition(overlay, hotspotEntity) {
          const updatePosition = () => {
            try {
              const camera = document.querySelector("[camera]");
              const canvas = document.querySelector("a-scene canvas");

              if (!camera || !canvas || !hotspotEntity.object3D) {
                requestAnimationFrame(updatePosition);
                return;
              }

              // Get 3D position
              const worldPos = new THREE.Vector3();
              hotspotEntity.object3D.getWorldPosition(worldPos);

              // Project to screen coordinates
              const screenPos = worldPos.clone();
              const camera3D = camera.object3D;
              screenPos.project(camera3D);

              // Convert to screen pixels
              const x = (screenPos.x * 0.5 + 0.5) * canvas.clientWidth;
              const y = (screenPos.y * -0.5 + 0.5) * canvas.clientHeight;

              // Check if hotspot is visible (in front of camera and on screen)
              const isVisible =
                screenPos.z < 1 &&
                x >= 0 &&
                x <= canvas.clientWidth &&
                y >= 0 &&
                y <= canvas.clientHeight;

              if (isVisible) {
                overlay.style.left = Math.round(x - 30) + "px";
                overlay.style.top = Math.round(y - 30) + "px";
                overlay.style.display = "block";
              } else {
                overlay.style.display = "none";
              }
            } catch (error) {
              console.error("Error updating overlay position:", error);
            }

            requestAnimationFrame(updatePosition);
          };

          requestAnimationFrame(updatePosition);
        }

        // Helper method to get Font Awesome icon character
        getIconCharacter(iconClass) {
          // Map of common Font Awesome icons to their Unicode characters
          const iconMap = {
            "fas fa-info-circle": "!",
            "fas fa-question-circle": "?",
            "fas fa-exclamation-triangle": "",
            "fas fa-lightbulb": "",
            "fas fa-book": "",
            "fas fa-arrow-up": "",
            "fas fa-arrow-down": "",
            "fas fa-arrow-left": "",
            "fas fa-arrow-right": "",
            "fas fa-compass": "",
            "fas fa-map-marker-alt": "",
            "fas fa-building": "",
            "fas fa-user-tie": "",
            "fas fa-users": "",
            "fas fa-briefcase": "",
            "fas fa-desk": "",
            "fas fa-concierge-bell": "",
            "fas fa-phone": "",
            "fas fa-envelope": "",
            "fas fa-calendar": "",
            "fas fa-clipboard-check": "",
            "fas fa-restroom": "",
            "fas fa-elevator": "",
            "fas fa-stairs": "",
            "fas fa-coffee": "",
            "fas fa-parking": "",
            "fas fa-wheelchair": "",
          };

          return iconMap[iconClass] || "";
        }

        makeDraggable(entity, hotspot) {
          let isDragging = false;
          let mouseMoveHandler = null;
          let mouseUpHandler = null;
          let dragYawOffset = 0;
          let dragPitchOffset = 0;
          let lastAppliedYaw = null;
          let lastAppliedPitch = null;

          const startDrag = (event) => {
            console.debug('[AFRAME] startDrag for hotspot', hotspot.id, event && event.type);
            isDragging = true;
            event.preventDefault();
            event.stopPropagation();

            const pos = hotspot.position || { x: 0, y: 0, z: -8 };
            const radius = Math.sqrt(pos.x * pos.x + pos.y * pos.y + pos.z * pos.z) || 8;
            const hotspotYaw = Math.atan2(pos.x, -pos.z) * (180 / Math.PI);
            const hotspotPitch = Math.asin(pos.y / radius) * (180 / Math.PI);

            try {
              const scene = document.getElementById("panorama-scene");
              const canvas = scene.querySelector("canvas");
              const canvasBounds = canvas.getBoundingClientRect();
              const relX = event.clientX - canvasBounds.left;
              const relY = event.clientY - canvasBounds.top;
              const w = canvasBounds.width || window.innerWidth;
              const h = canvasBounds.height || window.innerHeight;
              const nx = Math.max(0, Math.min(1, relX / w));
              const ny = Math.max(0, Math.min(1, relY / h));
              const cursorYaw = nx * 360 - 180;
              const cursorPitch = (0.5 - ny) * 180;

              dragYawOffset = hotspotYaw - cursorYaw;
              dragPitchOffset = hotspotPitch - cursorPitch;
            } catch (e) {
              dragYawOffset = 0;
              dragPitchOffset = 0;
            }

            lastAppliedYaw = hotspotYaw;
            lastAppliedPitch = hotspotPitch;

            // Create bound handlers for this specific drag operation
            mouseMoveHandler = (moveEvent) => {
              if (!isDragging) return;
              console.debug('[AFRAME] mouseMoveHandler', { clientX: moveEvent.clientX, clientY: moveEvent.clientY });

              // Get the A-Frame scene and camera
              const scene = document.getElementById("panorama-scene");
              const canvas = scene.querySelector("canvas");
              const cameraEl = scene.querySelector("[camera]");

              if (!canvas || !cameraEl || !cameraEl.getObject3D("camera")) {
                console.warn("Canvas or camera not ready for dragging");
                return;
              }

              // Map screen mouse coordinates to spherical yaw/pitch and convert to Cartesian
              try {
                const canvasBounds = canvas.getBoundingClientRect();
                const relX = moveEvent.clientX - canvasBounds.left;
                const relY = moveEvent.clientY - canvasBounds.top;
                const w = canvasBounds.width || window.innerWidth;
                const h = canvasBounds.height || window.innerHeight;

                const nx = Math.max(0, Math.min(1, relX / w));
                const ny = Math.max(0, Math.min(1, relY / h));

                const cursorYaw = nx * 360 - 180;
                const cursorPitch = (0.5 - ny) * 180;

                const normalizeAngle = (angle) => {
                  let a = angle;
                  while (a > 180) a -= 360;
                  while (a < -180) a += 360;
                  return a;
                };

                const targetYaw = cursorYaw + (typeof dragYawOffset === 'number' ? dragYawOffset : 0);
                const targetPitch = cursorPitch + (typeof dragPitchOffset === 'number' ? dragPitchOffset : 0);

                // Use smooth interpolation with stronger damping to prevent fast, erratic movement
                const smoothingFactor = 0.15; // Matches PhotoSphere viewer - slow and accurate

                let newYaw = targetYaw;
                if (typeof lastAppliedYaw === 'number') {
                  const deltaYaw = normalizeAngle(targetYaw - lastAppliedYaw);
                  // Interpolate smoothly toward target
                  newYaw = normalizeAngle(lastAppliedYaw + deltaYaw * smoothingFactor);
                } else {
                  newYaw = normalizeAngle(newYaw);
                }

                let newPitch = targetPitch;
                if (typeof lastAppliedPitch === 'number') {
                  const deltaPitch = targetPitch - lastAppliedPitch;
                  // Interpolate smoothly toward target
                  newPitch = lastAppliedPitch + deltaPitch * smoothingFactor;
                }

                newPitch = Math.max(-90, Math.min(90, newPitch));

                lastAppliedYaw = newYaw;
                lastAppliedPitch = newPitch;

                const yawRad = (newYaw * Math.PI) / 180;
                const pitchRad = (newPitch * Math.PI) / 180;

                const radius = 8;
                const nxPos = radius * Math.sin(yawRad) * Math.cos(pitchRad);
                const nyPos = radius * Math.sin(pitchRad);
                const nzPos = -radius * Math.cos(yawRad) * Math.cos(pitchRad);

                console.debug('[AFRAME] computed yaw/pitch -> pos', { yaw: newYaw, pitch: newPitch, nxPos, nyPos, nzPos });
                entity.setAttribute("position", `${nxPos} ${nyPos} ${nzPos}`);
                entity.setAttribute("look-at", "[camera]");

                hotspot.position = { x: nxPos, y: nyPos, z: nzPos };
                hotspot.yaw = newYaw;
                hotspot.pitch = newPitch;
              } catch (e) {
                console.warn('Drag mapping failed, falling back to raycast:', e);
              }
            };

            mouseUpHandler = () => {
              console.debug('[AFRAME] mouseUpHandler for hotspot', hotspot.id);
              isDragging = false;

              // Remove the specific event listeners
              if (mouseMoveHandler) {
                document.removeEventListener("mousemove", mouseMoveHandler);
              }
              if (mouseUpHandler) {
                document.removeEventListener("mouseup", mouseUpHandler);
              }

              mouseMoveHandler = null;
              mouseUpHandler = null;
            };

            // Add event listeners for this drag operation
            document.addEventListener("mousemove", mouseMoveHandler);
            document.addEventListener("mouseup", mouseUpHandler);
          };

          // Add mousedown listener to start dragging
          entity.addEventListener("mousedown", startDrag);
        }

        selectHotspot(hotspot) {
          // Deselect previous
          if (this.selectedHotspot) {
            const prevEntity = document.getElementById(this.selectedHotspot.id);
            if (prevEntity) {
              const prevColor =
                this.selectedHotspot.type === "navigation"
                  ? "#ffa500"
                  : "#04aa6d";
              prevEntity.setAttribute(
                "material",
                `color: ${prevColor}; emissive: ${prevColor}; emissiveIntensity: 0.3`
              );
            }
          }

          // Select new
          this.selectedHotspot = hotspot;
          const entity = document.getElementById(hotspot.id);
          if (entity) {
            entity.setAttribute(
              "material",
              "color: #ffd700; emissive: #ffd700; emissiveIntensity: 0.5"
            );
          }

          // Update form
          document.getElementById("hotspot-title").value = hotspot.title;
          document.getElementById("hotspot-description").value =
            hotspot.description;
          document.getElementById("hotspot-type").value = hotspot.type;
          document.getElementById("hotspot-target").value =
            hotspot.target || "";

          // Handle navigation section visibility
          this.updateFormSections();

          // Set navigation target if it's a navigation hotspot
          if (hotspot.type === "navigation" && hotspot.linkPathId) {
            const targetSelect = document.getElementById("navigation-target");
            const targetValue = `${hotspot.linkPathId}:${hotspot.linkPointIndex}:${hotspot.linkFloorNumber}`;
            targetSelect.value = targetValue;
          }

          // Show update/delete buttons
          document.getElementById("update-hotspot-btn").style.display =
            "inline-block";
          document.getElementById("delete-hotspot-btn").style.display =
            "inline-block";

          this.updateHotspotList();
        }

        updateFormSections() {
          const type = document.getElementById("hotspot-type").value;
          const navigationSection =
            document.getElementById("navigation-section");
          const externalSection = document.getElementById("external-section");

          if (type === "navigation") {
            navigationSection.style.display = "block";
            externalSection.style.display = "none";
          } else {
            navigationSection.style.display = "none";
            externalSection.style.display = "block";
          }
        }

        navigateToHotspot(hotspot) {
          if (!hotspot.linkPathId || hotspot.linkPointIndex === null) {
            alert("Navigation hotspot is not properly configured");
            return;
          }

          if (confirm(`Navigate to ${hotspot.title}?`)) {
            // Construct new URL for the target panorama
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set("pathId", hotspot.linkPathId);
            newUrl.searchParams.set("pointIndex", hotspot.linkPointIndex);
            newUrl.searchParams.set("floor", hotspot.linkFloorNumber || 1);

            // Navigate to the new panorama
            window.location.href = newUrl.toString();
          }
        }

        loadAvailablePanoramas() {
          if (!this.pathId || !this.pointIndex) return;

          const params = new URLSearchParams({
            action: "get_linkable_panoramas",
            current_path_id: this.pathId,
            current_point_index: this.pointIndex,
            current_floor: this.floor || 1,
          });

          fetch(`panorama_api.php?${params.toString()}`)
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                this.availablePanoramas = data.panoramas;
                this.populateNavigationTargets();
              }
            })
            .catch((error) => {
              console.error("Error loading available panoramas:", error);
            });
        }

        populateNavigationTargets() {
          const select = document.getElementById("navigation-target");
          select.innerHTML =
            '<option value="">Select panorama to link...</option>';

          // Group panoramas by floor for better organization
          const groupedPanoramas = {};
          this.availablePanoramas.forEach((pano) => {
            const floorKey = `Floor ${pano.floor_number}`;
            if (!groupedPanoramas[floorKey]) {
              groupedPanoramas[floorKey] = [];
            }
            groupedPanoramas[floorKey].push(pano);
          });

          // Add options grouped by floor
          Object.keys(groupedPanoramas)
            .sort((a, b) => {
              const floorA = parseInt(a.replace("Floor ", ""));
              const floorB = parseInt(b.replace("Floor ", ""));
              return floorA - floorB;
            })
            .forEach((floorKey) => {
              // Add floor group header
              const floorGroup = document.createElement("optgroup");
              floorGroup.label = ` ${floorKey}`;
              select.appendChild(floorGroup);

              groupedPanoramas[floorKey].forEach((pano) => {
                const option = document.createElement("option");
                option.value = `${pano.path_id}:${pano.point_index}:${pano.floor_number}`;

                // Use enhanced display title if available, otherwise create one
                let displayText = "";
                if (pano.display_title) {
                  displayText = pano.display_title;
                } else if (pano.title) {
                  displayText = `${pano.title} (${pano.path_id} Point ${pano.point_index})`;
                } else {
                  displayText = ` ${pano.path_id} Point ${pano.point_index}`;
                }

                option.textContent = displayText;
                option.title = `Navigate to: ${displayText}\nDescription: ${
                  pano.description || "No description available"
                }`;

                floorGroup.appendChild(option);
              });
            });

          // Add summary info
          const summaryOption = document.createElement("option");
          summaryOption.disabled = true;
          summaryOption.textContent = ` Total: ${this.availablePanoramas.length} panorama points available`;
          summaryOption.style.fontStyle = "italic";
          summaryOption.style.color = "#666";
          select.appendChild(summaryOption);

          console.log(
            ` Navigation targets populated: ${this.availablePanoramas.length} panoramas available for linking`
          );

          // Update preview if there's already a selected value (when editing existing hotspot)
          const currentValue =
            document.getElementById("navigation-target").value;
          if (currentValue) {
            this.updateNavigationPreview(currentValue);
          }
        }

        updateSelectedHotspot() {
          if (!this.selectedHotspot) return;

          this.selectedHotspot.title =
            document.getElementById("hotspot-title").value;
          this.selectedHotspot.description = document.getElementById(
            "hotspot-description"
          ).value;
          this.selectedHotspot.type =
            document.getElementById("hotspot-type").value;

          // Handle navigation vs external target
          if (this.selectedHotspot.type === "navigation") {
            const navigationTarget =
              document.getElementById("navigation-target").value;
            if (navigationTarget) {
              const parts = navigationTarget.split(":");
              this.selectedHotspot.linkType = "panorama";
              this.selectedHotspot.linkPathId = parts[0];
              this.selectedHotspot.linkPointIndex = parseInt(parts[1]);
              this.selectedHotspot.linkFloorNumber = parseInt(parts[2]);
              this.selectedHotspot.target = `Navigate to ${parts[0]} Point ${parts[1]}`;
            } else {
              this.selectedHotspot.linkType = "none";
              this.selectedHotspot.target =
                document.getElementById("hotspot-target").value;
            }
          } else {
            this.selectedHotspot.linkType = "none";
            this.selectedHotspot.target =
              document.getElementById("hotspot-target").value;
          }

          // Update entity appearance and label
          const entity = document.getElementById(this.selectedHotspot.id);
          if (entity) {
            const label = entity.querySelector("a-text");
            if (
              label &&
              label.getAttribute("value") !== this.selectedHotspot.title
            ) {
              label.setAttribute("value", this.selectedHotspot.title);
            }

            // Update color based on type
            const newColor =
              this.selectedHotspot.type === "navigation"
                ? "#ffa500"
                : "#04aa6d";
            const material = entity.getAttribute("material");
            if (material && !material.includes("#ffd700")) {
              // Don't change if selected
              entity.setAttribute(
                "material",
                `color: ${newColor}; transparent: true; opacity: 0.9; side: double`
              );
            }
          }

          this.updateHotspotList();
        }

        deleteSelectedHotspot() {
          if (!this.selectedHotspot) return;

          if (confirm("Are you sure you want to delete this hotspot?")) {
            // Remove entity
            const entity = document.getElementById(this.selectedHotspot.id);
            if (entity) {
              entity.parentNode.removeChild(entity);
            }

            // Clean up animated GIF overlay if it exists
            const overlayId = `gif-overlay-${this.selectedHotspot.id}`;
            const overlay = document.getElementById(overlayId);
            if (overlay) {
              overlay.parentNode.removeChild(overlay);
              console.log("Cleaned up animated GIF overlay:", overlayId);
            }

            // Remove from array
            this.hotspots = this.hotspots.filter(
              (h) => h.id !== this.selectedHotspot.id
            );

            this.selectedHotspot = null;
            this.clearForm();
            this.updateHotspotList();
          }
        }

        clearForm() {
          document.getElementById("hotspot-title").value = "";
          document.getElementById("hotspot-description").value = "";
          document.getElementById("hotspot-type").value = "info";
          document.getElementById("hotspot-target").value = "";
          document.getElementById("update-hotspot-btn").style.display = "none";
          document.getElementById("delete-hotspot-btn").style.display = "none";
        }

        updateHotspotList() {
          const container = document.getElementById("hotspot-list-container");

          if (this.hotspots.length === 0) {
            container.innerHTML =
              '<p style="color: #888; text-align: center;">No hotspots added yet</p>';
            return;
          }

          container.innerHTML = "";

          this.hotspots.forEach((hotspot) => {
            const item = document.createElement("div");
            item.className = "hotspot-item";
            if (
              this.selectedHotspot &&
              this.selectedHotspot.id === hotspot.id
            ) {
              item.classList.add("selected");
            }

            item.innerHTML = `
                        <h4>${hotspot.title}</h4>
                        <p>Type: ${hotspot.type}</p>
                        <p>${hotspot.description}</p>
                        <div class="hotspot-actions">
                            <button class="btn" onclick="editor.selectHotspot(editor.hotspots.find(h => h.id === '${hotspot.id}'))">Edit</button>
                            <button class="btn btn-danger" onclick="editor.deleteHotspotById('${hotspot.id}')">Delete</button>
                        </div>
                    `;

            container.appendChild(item);
          });
        }

        deleteHotspotById(id) {
          const hotspot = this.hotspots.find((h) => h.id === id);
          if (hotspot) {
            this.selectedHotspot = hotspot;
            this.deleteSelectedHotspot();
          }
        }

        loadHotspots() {
          // Load existing hotspots for this panorama point
          if (!this.pathId || !this.pointIndex) {
            console.log(
              " Cannot load hotspots - missing pathId or pointIndex:",
              {
                pathId: this.pathId,
                pointIndex: this.pointIndex,
              }
            );
            return;
          }

          console.log(" Loading hotspots for panorama:", {
            pathId: this.pathId,
            pointIndex: this.pointIndex,
            floor: this.floor || 1,
          });

          const params = new URLSearchParams({
            action: "get_hotspots",
            path_id: this.pathId,
            point_index: this.pointIndex,
            floor_number: this.floor || 1,
          });

          const apiUrl = `panorama_api.php?${params.toString()}`;
          console.log(" API call URL:", apiUrl);

          fetch(apiUrl)
            .then((response) => {
              console.log(" API response status:", response.status);
              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }
              return response.json();
            })
            .then((data) => {
              console.log(" Raw API response:", data);

              if (data.success && data.hotspots) {
                console.log(
                  ` Loading ${data.hotspots.length} hotspots from database`
                );

                this.hotspots = data.hotspots;

                // Verify scene is ready
                const scene = document.getElementById("panorama-scene");
                const hotspotsContainer =
                  document.getElementById("hotspots-container");

                if (!scene || !hotspotsContainer) {
                  console.error(" Scene or hotspots container not found!");
                  console.log("Scene:", scene, "Container:", hotspotsContainer);
                  return;
                }

                console.log(
                  " Scene and container verified, creating hotspot entities..."
                );

                // First, preload animated assets for any animated hotspots
                this.preloadAnimatedAssets().then(() => {
                  // Clear any existing hotspots first
                  this.clearAllHotspots();

                  // Then create hotspot entities
                  this.hotspots.forEach((hotspot, index) => {
                    console.log(
                      ` Processing hotspot ${index + 1}/${
                        this.hotspots.length
                      }:`,
                      {
                        id: hotspot.id,
                        title: hotspot.title,
                        position: hotspot.position,
                        hasAnimatedIcon: !!hotspot.animated_icon_path,
                        hasRotation: !!hotspot.rotation,
                        hasScale: !!hotspot.scale,
                        rotation: hotspot.rotation,
                        scale: hotspot.scale,
                      }
                    );

                    // Ensure backward compatibility for hotspots without icons
                    if (!hotspot.icon) {
                      hotspot.icon = "fas fa-info-circle"; // Default icon
                    }

                    // Ensure navigation properties exist
                    if (!hotspot.linkType) {
                      hotspot.linkType = "none";
                    }

                    try {
                      this.createHotspotEntity(hotspot);
                      console.log(
                        ` Hotspot entity created for: ${hotspot.title}`
                      );
                    } catch (error) {
                      console.error(
                        ` Failed to create hotspot entity for ${hotspot.title}:`,
                        error
                      );
                    }
                  });

                  this.updateHotspotList();
                  console.log(
                    ` Successfully loaded all ${this.hotspots.length} hotspots`
                  );
                });
              } else if (data.success && !data.hotspots) {
                console.log(" No hotspots found for this panorama point");
                this.hotspots = [];
                this.updateHotspotList();
              } else {
                console.error(
                  " API returned error:",
                  data.error || "Unknown error"
                );
              }
            })
            .catch((error) => {
              console.error(" Error loading hotspots:", error);
              console.error("API URL was:", apiUrl);
            });
        }

        // Clear all existing hotspot entities from the scene
        clearAllHotspots() {
          const hotspotsContainer =
            document.getElementById("hotspots-container");
          if (hotspotsContainer) {
            // Remove all children
            while (hotspotsContainer.firstChild) {
              hotspotsContainer.removeChild(hotspotsContainer.firstChild);
            }
            console.log(" Cleared all existing hotspot entities");
          }
        }

        // Preload animated assets using A-Frame's asset management system
        preloadAnimatedAssets() {
          const scene = document.getElementById("panorama-scene");
          if (!scene) return Promise.resolve();

          // Get unique animated icon IDs from hotspots
          const animatedIconIds = [
            ...new Set(
              this.hotspots
                .filter((h) => h.animated_icon_id || h.animated_icon_path)
                .map((h) => h.animated_icon_id)
                .filter((id) => id)
            ),
          ];

          if (animatedIconIds.length === 0) {
            console.log(" No animated assets to preload");
            return Promise.resolve();
          }

          console.log(
            " Preloading animated assets for IDs:",
            animatedIconIds
          );

          // Fetch animated icon data for asset URLs
          return fetch("animated_hotspot_manager.php?action=list")
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                const assetsToLoad = data.icons
                  .filter((icon) => animatedIconIds.includes(icon.id))
                  .map((icon) => ({
                    id: icon.id,
                    src: icon.icon_file_path,
                  }));

                console.log(" Assets to preload:", assetsToLoad);

                // Use the hotspot manager system to preload assets
                const system = scene.systems["animated-hotspot-manager"];
                if (system) {
                  system.preloadAnimatedAssets(assetsToLoad);
                } else {
                  console.warn(" Animated hotspot system not found");
                }

                return assetsToLoad;
              }
              return [];
            })
            .catch((error) => {
              console.error(" Error preloading animated assets:", error);
              return [];
            });
        }

        saveHotspots() {
          // Make sure transform values are saved for all hotspots
          this.hotspots.forEach((hotspot) => {
            console.log(
              " Processing hotspot for save:",
              hotspot.title,
              hotspot.rotation,
              hotspot.scale
            );

            // Don't overwrite existing stored transform values unless needed
            const entity = document.getElementById(hotspot.id);
            if (entity) {
              const rotation = entity.getAttribute("rotation");
              const scale = entity.getAttribute("scale");

              console.log(" Entity attributes:", {
                rotation: rotation,
                scale: scale,
                hasStoredRotation: !!hotspot.rotation,
                hasStoredScale: !!hotspot.scale,
              });

              // Only update if we don't already have stored values, or if they're different
              if (rotation && !hotspot.rotation) {
                if (rotation.x !== 0 || rotation.y !== 0 || rotation.z !== 0) {
                  hotspot.rotation = rotation;
                }
              }

              if (scale && !hotspot.scale) {
                if (scale.x !== 1 || scale.y !== 1 || scale.z !== 1) {
                  hotspot.scale = scale;
                }
              }
            }
          });

          const formData = new FormData();
          formData.append("action", "save_hotspots");
          formData.append("path_id", this.pathId);
          formData.append("point_index", this.pointIndex);
          formData.append("floor_number", this.floor || 1);

          console.log(" Sending hotspots to database:", this.hotspots);
          console.log(" JSON String:", JSON.stringify(this.hotspots));

          formData.append("hotspots", JSON.stringify(this.hotspots));

          fetch("panorama_api.php", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                alert("Hotspots saved successfully!");
                // Notify parent window if opened from admin panel
                if (window.opener) {
                  window.opener.postMessage(
                    {
                      type: "hotspotsSaved",
                      pathId: this.pathId,
                      pointIndex: this.pointIndex,
                      hotspots: this.hotspots,
                    },
                    "*"
                  );
                }
              } else {
                alert(
                  "Error saving hotspots: " + (data.error || "Unknown error")
                );
              }
            })
            .catch((error) => {
              console.error("Error saving hotspots:", error);
              alert("Error saving hotspots: " + error.message);
            });
        }

        initIconSelection() {
          this.populateIcons();
          this.bindIconEvents();
        }

        populateIcons(category = "all") {
          const grid = document.getElementById("icons-grid");
          grid.innerHTML = "";

          let icons = [];
          if (category === "all") {
            // Combine all icons
            Object.values(this.iconLibrary).forEach((categoryIcons) => {
              icons.push(...categoryIcons);
            });
          } else {
            icons = this.iconLibrary[category] || [];
          }

          icons.forEach((iconData, index) => {
            const iconElement = document.createElement("div");
            iconElement.className = "icon-item";
            iconElement.dataset.icon = iconData.icon;
            iconElement.dataset.name = iconData.name;
            iconElement.dataset.type = iconData.type;

            iconElement.innerHTML = `
              <i class="${iconData.icon}"></i>
              <span>${iconData.name}</span>
            `;

            iconElement.addEventListener("click", () => {
              this.selectIcon(iconData, iconElement);
            });

            grid.appendChild(iconElement);
          });
        }

        bindIconEvents() {
          // Category buttons
          document.querySelectorAll(".category-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              // Update active category
              document
                .querySelectorAll(".category-btn")
                .forEach((b) => b.classList.remove("active"));
              btn.classList.add("active");

              // Populate icons for selected category
              this.populateIcons(btn.dataset.category);
            });
          });

          // Cancel icon selection
          document
            .getElementById("cancel-icon-selection")
            .addEventListener("click", () => {
              this.closeIconSelection();
            });

          // Close overlay when clicking outside
          document
            .getElementById("icon-selection-overlay")
            .addEventListener("click", (e) => {
              if (e.target.id === "icon-selection-overlay") {
                this.closeIconSelection();
              }
            });
        }

        showIconSelection() {
          const overlay = document.getElementById("icon-selection-overlay");
          overlay.classList.add("active");
          this.populateIcons(); // Reset to show all icons
        }

        closeIconSelection() {
          const overlay = document.getElementById("icon-selection-overlay");
          overlay.classList.remove("active");
          this.selectedIcon = null;
          this.stopIconDrag();

          // Reset add hotspot button
          const btn = document.getElementById("add-hotspot-btn");
          btn.textContent = " Add Video Hotspot";
          btn.style.background = "#04aa6d";
          this.isAddingMode = false;
        }

        openAnimatedIconsManagerDirect() {
          // Skip the static icon selection and go directly to animated icons manager
          if (typeof openAnimatedIconsManager === "function") {
            openAnimatedIconsManager();
          } else {
            // Fallback: show the animated icons modal directly
            document.getElementById("animated-icons-modal").style.display =
              "flex";
            // Load icons
            if (typeof loadAnimatedIcons === "function") {
              loadAnimatedIcons();
            }
          }
        }

        selectIcon(iconData, element) {
          // Remove previous selection
          document.querySelectorAll(".icon-item").forEach((item) => {
            item.classList.remove("selected");
          });

          // Select current icon
          element.classList.add("selected");
          this.selectedIcon = iconData;

          // Start drag immediately
          setTimeout(() => {
            this.startIconDrag();
          }, 100);
        }

        startIconDrag() {
          console.log("Starting icon drag with:", this.selectedIcon);

          if (!this.selectedIcon) {
            console.error("No selected icon to drag");
            return;
          }

          this.isDraggingIcon = true;
          const dragIcon = document.getElementById("dragging-icon");
          const instructions = document.getElementById("drag-instructions");

          console.log("Drag icon element:", dragIcon);
          console.log("Instructions element:", instructions);

          // Update dragging icon
          if (dragIcon) {
            dragIcon.innerHTML = `<i class="${this.selectedIcon.icon}"></i>`;
            dragIcon.style.display = "block";
            dragIcon.style.color = "#04aa6d";
            dragIcon.style.fontSize = "30px";
            console.log("Drag icon updated and displayed");
          }

          if (instructions) {
            instructions.style.display = "block";
            console.log("Instructions displayed");
          }

          // Close icon selection overlay
          const overlay = document.getElementById("icon-selection-overlay");
          if (overlay) {
            overlay.classList.remove("active");
            console.log("Overlay closed");
          }

          // Add mouse move listener
          document.addEventListener("mousemove", this.boundDragMove);
          document.addEventListener("click", this.boundDragClick);

          console.log("Event listeners added for drag");
        }

        onIconDragMove(event) {
          if (!this.isDraggingIcon) return;

          const dragIcon = document.getElementById("dragging-icon");
          if (dragIcon) {
            dragIcon.style.left = event.clientX + "px";
            dragIcon.style.top = event.clientY + "px";
          }
        }

        onIconDragClick(event) {
          if (!this.isDraggingIcon) return;

          // Prevent other handlers from interfering
          event.preventDefault();
          event.stopPropagation();

          console.log("Icon drag click detected", event.target);
          console.log("Current selected icon:", this.selectedIcon);
          console.log("isDraggingIcon state:", this.isDraggingIcon);

          // For now, let's use a simple approach - place at a fixed position for testing
          const testPosition = new THREE.Vector3(0, 0, -5); // 5 units in front of camera

          console.log(
            "Attempting to place hotspot at test position:",
            testPosition
          );
          this.placeHotspotWithIcon(testPosition);
          this.stopIconDrag();
        }

        stopIconDrag() {
          this.isDraggingIcon = false;
          document.getElementById("dragging-icon").style.display = "none";
          document.getElementById("drag-instructions").style.display = "none";

          // Remove event listeners
          document.removeEventListener("mousemove", this.boundDragMove);
          document.removeEventListener("click", this.boundDragClick);
        }

        placeHotspotWithIcon(position) {
          console.log(
            "Placing hotspot with icon:",
            this.selectedIcon,
            "at position:",
            position
          );

          if (!this.selectedIcon) {
            console.error("No selected icon for placement");
            return;
          }

          const hotspotId = "hotspot_" + Date.now();

          const hotspot = {
            id: hotspotId,
            position: position,
            title: this.selectedIcon.name,
            description: `${this.selectedIcon.name} hotspot`,
            type: this.selectedIcon.type,
            target: "",
            icon: this.selectedIcon.icon,
            created: new Date().toISOString(),
          };

          this.hotspots.push(hotspot);
          this.createHotspotEntity(hotspot);
          this.updateHotspotList();

          // Auto-select the new hotspot for editing
          this.selectHotspot(hotspot);

          // Reset state
          this.selectedIcon = null;
          this.isAddingMode = false;

          // Reset button
          const btn = document.getElementById("add-hotspot-btn");
          btn.textContent = " Add Video Hotspot";
          btn.style.background = "#04aa6d";
        }

        createTestHotspot() {
          console.log("Creating test hotspot...");

          const testPosition = new THREE.Vector3(2, 0, -3);
          const testIcon = {
            icon: "fas fa-info-circle",
            name: "Test Info",
            type: "info",
          };

          const hotspot = {
            id: "hotspot_test_" + Date.now(),
            position: testPosition,
            title: "Test Hotspot",
            description: "This is a test hotspot",
            type: "info",
            target: "",
            icon: "fas fa-info-circle",
            created: new Date().toISOString(),
          };

          this.hotspots.push(hotspot);
          this.createHotspotEntity(hotspot);
          this.updateHotspotList();

          console.log("Test hotspot created:", hotspot);
        }

        // Update all hotspots to face the camera (only for hotspots without manual transforms)
        updateHotspotBillboard() {
          const scene = document.getElementById("panorama-scene");
          const camera = scene.querySelector("[camera]");

          if (!camera || !camera.getObject3D("camera")) return;

          const cameraPosition = camera.getObject3D("camera").position;

          this.hotspots.forEach((hotspot) => {
            // Skip billboard update if hotspot has manual rotation or scale
            if (hotspot.rotation || hotspot.scale) {
              return; // Don't override manual transforms
            }

            const entity = document.getElementById(hotspot.id);
            if (entity) {
              // Only update if entity doesn't have look-at removed (manual rotation)
              if (entity.hasAttribute("look-at")) {
                // Calculate direction to camera
                const hotspotPos = new THREE.Vector3(
                  hotspot.position.x,
                  hotspot.position.y,
                  hotspot.position.z
                );

                // Make entity look at camera
                const lookDirection = new THREE.Vector3();
                lookDirection
                  .subVectors(cameraPosition, hotspotPos)
                  .normalize();

                // Set rotation to face camera
                const rotation = new THREE.Euler();
                rotation.setFromQuaternion(
                  new THREE.Quaternion().setFromUnitVectors(
                    new THREE.Vector3(0, 0, 1),
                    lookDirection
                  )
                );

                entity.setAttribute(
                  "rotation",
                  `${THREE.MathUtils.radToDeg(
                    rotation.x
                  )} ${THREE.MathUtils.radToDeg(
                    rotation.y
                  )} ${THREE.MathUtils.radToDeg(rotation.z)}`
                );
              }
            }
          });
        }

        // Start billboard update loop
        startBillboardUpdates() {
          setInterval(() => {
            this.updateHotspotBillboard();
          }, 100); // Update every 100ms
        }

        // Show hotspot settings controls
        showHotspotSettings(hotspot) {
          this.currentSettingsHotspot = hotspot;
          const settingsPanel = document.getElementById("hotspot-settings");
          const titleElement = document.getElementById("settings-title");

          // Update panel title
          titleElement.textContent = `Settings: ${hotspot.title || "Hotspot"}`;

          // Get current hotspot transform values from stored data first, then from entity
          const entity = document.getElementById(hotspot.id);
          if (!entity) return;

          // Use stored values if available, otherwise get from entity or defaults
          const storedRotation = hotspot.rotation || { x: 0, y: 0, z: 0 };
          const storedScale = hotspot.scale || { x: 1, y: 1, z: 1 };

          const currentRotation =
            entity.getAttribute("rotation") || storedRotation;
          const currentScale = entity.getAttribute("scale") || storedScale;

          // Set slider values using current values
          document.getElementById("rotation-x").value =
            currentRotation.x || storedRotation.x || 0;
          document.getElementById("rotation-y").value =
            currentRotation.y || storedRotation.y || 0;
          document.getElementById("scale").value =
            currentScale.x || storedScale.x || 1;

          // Update value displays
          document.getElementById("rotation-x-value").textContent = `${
            currentRotation.x || storedRotation.x || 0
          }`;
          document.getElementById("rotation-y-value").textContent = `${
            currentRotation.y || storedRotation.y || 0
          }`;
          document.getElementById("scale-value").textContent = `${(
            currentScale.x ||
            storedScale.x ||
            1
          ).toFixed(1)}x`;

          // Position settings panel near the hotspot
          this.positionSettingsPanel(hotspot, settingsPanel);

          // Show the panel
          settingsPanel.style.display = "block";

          // Bind slider events
          this.bindSettingsControls();

          // Hide any unsaved changes indicators when opening settings
          this.hideUnsavedChanges();

          // Refresh the panel after a short delay to ensure all values are current
          setTimeout(() => {
            this.refreshSettingsPanel();
          }, 100);
        }

        // Position settings panel near the hotspot
        positionSettingsPanel(hotspot, panel) {
          const scene = document.getElementById("panorama-scene");
          const canvas = scene.querySelector("canvas");
          const camera = scene.querySelector("[camera]");

          if (!canvas || !camera) return;

          // Calculate screen position of hotspot
          const canvasBounds = canvas.getBoundingClientRect();
          const hotspotPos = new THREE.Vector3(
            hotspot.position.x,
            hotspot.position.y,
            hotspot.position.z
          );

          // Project 3D position to screen coordinates
          const screenPos = hotspotPos.project(camera.getObject3D("camera"));

          // Convert to pixel coordinates
          const x =
            ((screenPos.x + 1) / 2) * canvasBounds.width + canvasBounds.left;
          const y =
            (-(screenPos.y - 1) / 2) * canvasBounds.height + canvasBounds.top;

          // Position panel with offset to avoid overlapping hotspot
          panel.style.left = Math.min(x + 50, window.innerWidth - 320) + "px";
          panel.style.top = Math.max(y - 100, 20) + "px";
        }

        // Bind settings control events
        bindSettingsControls() {
          const rotationX = document.getElementById("rotation-x");
          const rotationY = document.getElementById("rotation-y");
          const scaleSlider = document.getElementById("scale");

          // Remove existing listeners to prevent duplicates
          rotationX.removeEventListener("input", this.onRotationXChange);
          rotationY.removeEventListener("input", this.onRotationYChange);
          scaleSlider.removeEventListener("input", this.onScaleChange);

          // Bind new listeners
          this.onRotationXChange = (e) => {
            const value = e.target.value;
            document.getElementById(
              "rotation-x-value"
            ).textContent = `${value}`;
            this.updateHotspotTransform();
          };

          this.onRotationYChange = (e) => {
            const value = e.target.value;
            document.getElementById(
              "rotation-y-value"
            ).textContent = `${value}`;
            this.updateHotspotTransform();
          };

          this.onScaleChange = (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById(
              "scale-value"
            ).textContent = `${value.toFixed(1)}x`;
            this.updateHotspotTransform();
          };

          // Add multiple event types for better responsiveness and persistence
          rotationX.addEventListener("input", this.onRotationXChange);
          rotationX.addEventListener("change", this.onRotationXChange);
          rotationY.addEventListener("input", this.onRotationYChange);
          rotationY.addEventListener("change", this.onRotationYChange);
          scaleSlider.addEventListener("input", this.onScaleChange);
          scaleSlider.addEventListener("change", this.onScaleChange);
        }

        // Update hotspot transform based on control values
        updateHotspotTransform() {
          if (!this.currentSettingsHotspot) return;

          const entity = document.getElementById(
            this.currentSettingsHotspot.id
          );
          if (!entity) return;

          const rotationX = parseFloat(
            document.getElementById("rotation-x").value
          );
          const rotationY = parseFloat(
            document.getElementById("rotation-y").value
          );
          const scaleValue = parseFloat(document.getElementById("scale").value);

          // Apply rotation (don't use look-at when manually rotating)
          entity.removeAttribute("look-at");
          entity.setAttribute("rotation", `${rotationX} ${rotationY} 0`);

          // Apply scale with force update
          entity.setAttribute(
            "scale",
            `${scaleValue} ${scaleValue} ${scaleValue}`
          );

          // Immediately store transform values in hotspot data to prevent override
          this.currentSettingsHotspot.rotation = {
            x: rotationX,
            y: rotationY,
            z: 0,
          };
          this.currentSettingsHotspot.scale = {
            x: scaleValue,
            y: scaleValue,
            z: scaleValue,
          };

          // Update the hotspot in the main array immediately
          const hotspotIndex = this.hotspots.findIndex(
            (h) => h.id === this.currentSettingsHotspot.id
          );
          if (hotspotIndex !== -1) {
            this.hotspots[hotspotIndex].rotation =
              this.currentSettingsHotspot.rotation;
            this.hotspots[hotspotIndex].scale =
              this.currentSettingsHotspot.scale;
          }

          // Show unsaved changes indicator
          this.showUnsavedChanges();

          console.log(" Transform updated:", {
            hotspot: this.currentSettingsHotspot.title,
            rotation: this.currentSettingsHotspot.rotation,
            scale: this.currentSettingsHotspot.scale,
            entityScale: entity.getAttribute("scale"),
            entityRotation: entity.getAttribute("rotation"),
          });
        }

        // Reset hotspot transform to defaults
        resetHotspotTransform() {
          if (!this.currentSettingsHotspot) return;

          const entity = document.getElementById(
            this.currentSettingsHotspot.id
          );
          if (!entity) return;

          // Reset sliders
          document.getElementById("rotation-x").value = 0;
          document.getElementById("rotation-y").value = 0;
          document.getElementById("scale").value = 1;

          // Reset value displays
          document.getElementById("rotation-x-value").textContent = "0";
          document.getElementById("rotation-y-value").textContent = "0";
          document.getElementById("scale-value").textContent = "1.0x";

          // Reset entity transform
          entity.setAttribute("rotation", "0 0 0");
          entity.setAttribute("scale", "1 1 1");
          entity.setAttribute("look-at", "[camera]"); // Re-enable billboard behavior

          // Clear stored transform values from both current hotspot and main array
          delete this.currentSettingsHotspot.rotation;
          delete this.currentSettingsHotspot.scale;

          // Also clear from main array
          const hotspotIndex = this.hotspots.findIndex(
            (h) => h.id === this.currentSettingsHotspot.id
          );
          if (hotspotIndex !== -1) {
            delete this.hotspots[hotspotIndex].rotation;
            delete this.hotspots[hotspotIndex].scale;
          }
        }

        // Hide hotspot settings panel
        hideHotspotSettings() {
          const settingsPanel = document.getElementById("hotspot-settings");
          settingsPanel.style.display = "none";
          this.currentSettingsHotspot = null;
        }

        // Refresh settings panel with current values (force update)
        refreshSettingsPanel() {
          if (!this.currentSettingsHotspot) return;

          const entity = document.getElementById(
            this.currentSettingsHotspot.id
          );
          if (!entity) return;

          // Get actual current values from entity
          const currentRotation = entity.getAttribute("rotation");
          const currentScale = entity.getAttribute("scale");

          console.log(" Refreshing settings with current values:", {
            rotation: currentRotation,
            scale: currentScale,
          });

          // Update sliders with actual values
          if (currentRotation) {
            document.getElementById("rotation-x").value =
              currentRotation.x || 0;
            document.getElementById("rotation-y").value =
              currentRotation.y || 0;
            document.getElementById("rotation-x-value").textContent = `${
              currentRotation.x || 0
            }`;
            document.getElementById("rotation-y-value").textContent = `${
              currentRotation.y || 0
            }`;
          }

          if (currentScale) {
            document.getElementById("scale").value = currentScale.x || 1;
            document.getElementById("scale-value").textContent = `${(
              currentScale.x || 1
            ).toFixed(1)}x`;
          }
        }

        // Show unsaved changes indicator
        showUnsavedChanges() {
          const saveButton = document.querySelector(
            'button[onclick="editor.saveCurrentHotspotTransform()"]'
          );
          const settingsTitle = document.getElementById("settings-title");

          if (saveButton) {
            saveButton.style.animation = "pulseGreen 2s infinite";
            saveButton.innerHTML = " Save*";
          }

          if (settingsTitle && !settingsTitle.textContent.includes("*")) {
            settingsTitle.textContent += " *";
            settingsTitle.style.color = "#ffa500";
          }

          // Add pulsing animation if not already added
          if (!document.head.querySelector("style[data-pulse-styles]")) {
            const style = document.createElement("style");
            style.setAttribute("data-pulse-styles", "true");
            style.textContent = `
              @keyframes pulseGreen {
                0% { box-shadow: 0 0 5px #28a745; }
                50% { box-shadow: 0 0 15px #28a745, 0 0 25px #28a745; }
                100% { box-shadow: 0 0 5px #28a745; }
              }
            `;
            document.head.appendChild(style);
          }
        }

        // Hide unsaved changes indicator
        hideUnsavedChanges() {
          const saveButton = document.querySelector(
            'button[onclick="editor.saveCurrentHotspotTransform()"]'
          );
          const settingsTitle = document.getElementById("settings-title");

          if (saveButton) {
            saveButton.style.animation = "";
            saveButton.innerHTML = " Save";
          }

          if (settingsTitle) {
            settingsTitle.textContent = settingsTitle.textContent.replace(
              " *",
              ""
            );
            settingsTitle.style.color = "#04aa6d";
          }
        }

        // Save current hotspot transform changes
        saveCurrentHotspotTransform() {
          if (!this.currentSettingsHotspot) {
            alert("No hotspot selected for saving");
            return;
          }

          // Get current transform values from sliders
          const rotationX = parseFloat(
            document.getElementById("rotation-x").value
          );
          const rotationY = parseFloat(
            document.getElementById("rotation-y").value
          );
          const scaleValue = parseFloat(document.getElementById("scale").value);

          // Update the entity immediately
          const entity = document.getElementById(
            this.currentSettingsHotspot.id
          );
          if (entity) {
            entity.removeAttribute("look-at");
            entity.setAttribute("rotation", `${rotationX} ${rotationY} 0`);
            entity.setAttribute(
              "scale",
              `${scaleValue} ${scaleValue} ${scaleValue}`
            );
          }

          // Store in hotspot data
          this.currentSettingsHotspot.rotation = {
            x: rotationX,
            y: rotationY,
            z: 0,
          };
          this.currentSettingsHotspot.scale = {
            x: scaleValue,
            y: scaleValue,
            z: scaleValue,
          };

          // Update main hotspots array
          const hotspotIndex = this.hotspots.findIndex(
            (h) => h.id === this.currentSettingsHotspot.id
          );
          if (hotspotIndex !== -1) {
            this.hotspots[hotspotIndex].rotation =
              this.currentSettingsHotspot.rotation;
            this.hotspots[hotspotIndex].scale =
              this.currentSettingsHotspot.scale;
          }

          console.log(" Hotspot data before save:", {
            hotspotIndex: hotspotIndex,
            hotspotData: this.hotspots[hotspotIndex],
            allHotspots: this.hotspots,
          });

          // Save to database - use direct save to ensure transform data persistence
          this.saveTransformToDatabase().then((success) => {
            if (success) {
              // Hide unsaved changes indicator
              this.hideUnsavedChanges();

              // Show success message
              this.showTemporaryMessage(
                " Hotspot transform saved successfully!",
                "#28a745"
              );
            }
            // Error message already shown in saveTransformToDatabase if failed
          });

          console.log(" Hotspot transform saved:", {
            title: this.currentSettingsHotspot.title,
            rotation: this.currentSettingsHotspot.rotation,
            scale: this.currentSettingsHotspot.scale,
          });
        }

        // Save transform data directly to database
        saveTransformToDatabase() {
          const formData = new FormData();
          formData.append("action", "save_hotspots");
          formData.append("path_id", this.pathId);
          formData.append("point_index", this.pointIndex);
          formData.append("floor_number", this.floor || 1);

          // Ensure all hotspots have up-to-date transform data
          const hotspotsCopy = JSON.parse(JSON.stringify(this.hotspots));

          console.log(" Transform save - hotspots data:", hotspotsCopy);

          formData.append("hotspots", JSON.stringify(hotspotsCopy));

          return fetch("panorama_api.php", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                console.log(" Transform saved to database successfully");
                return true;
              } else {
                console.error(" Failed to save transform:", data.error);
                this.showTemporaryMessage(
                  " Failed to save changes: " +
                    (data.error || "Unknown error"),
                  "#dc3545"
                );
                return false;
              }
            })
            .catch((error) => {
              console.error(" Error saving transform:", error);
              this.showTemporaryMessage(
                " Network error while saving",
                "#dc3545"
              );
              return false;
            });
        }

        // Show temporary success/error message
        showTemporaryMessage(message, color = "#04aa6d") {
          const messageEl = document.createElement("div");
          messageEl.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${color};
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 6000;
            font-family: Arial, sans-serif;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideInRight 0.3s ease;
          `;
          messageEl.textContent = message;

          // Add slide animation
          const style = document.createElement("style");
          style.textContent = `
            @keyframes slideInRight {
              from { transform: translateX(100%); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
          `;
          if (!document.head.querySelector("style[data-message-styles]")) {
            style.setAttribute("data-message-styles", "true");
            document.head.appendChild(style);
          }

          document.body.appendChild(messageEl);

          // Remove after 3 seconds
          setTimeout(() => {
            if (document.body.contains(messageEl)) {
              messageEl.style.animation = "slideInRight 0.3s ease reverse";
              setTimeout(() => {
                if (document.body.contains(messageEl)) {
                  document.body.removeChild(messageEl);
                }
              }, 300);
            }
          }, 3000);
        }

        // Test method to validate transform persistence
        validateTransformPersistence() {
          if (!this.currentSettingsHotspot) return;

          console.log(" Validating transform persistence:");
          console.log("Current hotspot data:", this.currentSettingsHotspot);

          const entity = document.getElementById(
            this.currentSettingsHotspot.id
          );
          if (entity) {
            const currentRotation = entity.getAttribute("rotation");
            const currentScale = entity.getAttribute("scale");

            console.log("Entity transform:", {
              rotation: currentRotation,
              scale: currentScale,
            });

            console.log("Stored transform:", {
              rotation: this.currentSettingsHotspot.rotation,
              scale: this.currentSettingsHotspot.scale,
            });
          }

          // Test re-saving the data
          this.showTemporaryMessage(
            " Validation complete - check console for details",
            "#17a2b8"
          );
        }

        // Delete currently selected hotspot from settings
        deleteCurrentHotspot() {
          if (!this.currentSettingsHotspot) return;

          if (
            confirm(`Delete hotspot "${this.currentSettingsHotspot.title}"?`)
          ) {
            // Remove entity
            const entity = document.getElementById(
              this.currentSettingsHotspot.id
            );
            if (entity) {
              entity.parentNode.removeChild(entity);
            }

            // Remove from array
            this.hotspots = this.hotspots.filter(
              (h) => h.id !== this.currentSettingsHotspot.id
            );

            // Hide settings and update list
            this.hideHotspotSettings();
            this.updateHotspotList();
          }
        }

        updateNavigationPreview(selectedValue) {
          const previewDiv = document.getElementById("navigation-preview");
          const previewText = document.getElementById(
            "navigation-preview-text"
          );

          if (!selectedValue) {
            previewDiv.style.display = "none";
            return;
          }

          // Find the selected panorama data
          const parts = selectedValue.split(":");
          if (parts.length !== 3) {
            previewDiv.style.display = "none";
            return;
          }

          const [pathId, pointIndex, floorNumber] = parts;
          const selectedPano = this.availablePanoramas.find(
            (p) =>
              p.path_id === pathId &&
              p.point_index === parseInt(pointIndex) &&
              p.floor_number === parseInt(floorNumber)
          );

          if (selectedPano) {
            let previewContent = "";
            if (selectedPano.display_title) {
              previewContent = selectedPano.display_title;
            } else if (selectedPano.title) {
              previewContent = `${selectedPano.title} (Floor ${floorNumber})`;
            } else {
              previewContent = `Floor ${floorNumber} - ${pathId} Point ${pointIndex}`;
            }

            previewText.textContent = previewContent;
            previewDiv.style.display = "block";

            console.log(` Navigation target selected: ${previewContent}`);
          } else {
            previewDiv.style.display = "none";
          }
        }

        bindEvents() {
          // Add hotspot button - show animated icons manager directly
          document
            .getElementById("add-hotspot-btn")
            .addEventListener("click", () => {
              this.openAnimatedIconsManagerDirect();
            });

          // Test hotspot button - create immediately
          document
            .getElementById("test-hotspot-btn")
            .addEventListener("click", () => {
              this.createTestHotspot();
            });

          // Update selected hotspot
          document
            .getElementById("update-hotspot-btn")
            .addEventListener("click", () => {
              this.updateSelectedHotspot();
            });

          // Delete selected hotspot
          document
            .getElementById("delete-hotspot-btn")
            .addEventListener("click", () => {
              this.deleteSelectedHotspot();
            });

          // Save hotspots
          document
            .getElementById("save-hotspots-btn")
            .addEventListener("click", () => {
              this.saveHotspots();
            });

          // Close editor
          document
            .getElementById("close-editor-btn")
            .addEventListener("click", () => {
              if (window.opener) {
                window.opener.postMessage({ type: "editorClosed" }, "*");
              }
              window.close();
            });

          // Handle hotspot type change
          document
            .getElementById("hotspot-type")
            .addEventListener("change", () => {
              this.updateFormSections();
            });

          // Refresh navigation targets
          document
            .getElementById("refresh-targets")
            .addEventListener("click", () => {
              this.loadAvailablePanoramas();
            });

          // Navigation target selection preview
          document
            .getElementById("navigation-target")
            .addEventListener("change", (e) => {
              this.updateNavigationPreview(e.target.value);
            });

          // Keyboard shortcuts
          document.addEventListener("keydown", (event) => {
            if (event.key === "Delete" && this.selectedHotspot) {
              this.deleteSelectedHotspot();
            } else if (event.key === "Escape") {
              // Close settings panel if open
              if (this.currentSettingsHotspot) {
                this.hideHotspotSettings();
              } else {
                this.selectedHotspot = null;
                this.clearForm();
                this.updateHotspotList();
              }
            } else if (event.ctrlKey && event.key === "s") {
              event.preventDefault();
              this.saveHotspots();
            }
          });
        }
      }

      // Initialize editor when page loads
      let editor;
      document.addEventListener("DOMContentLoaded", () => {
        editor = new PanoramaHotspotEditor();
        // Store globally for access from other functions
        window.panoramaEditor = editor;
      });

      // Mobile View Toggle Function
      let isMobileView = false;
      function toggleMobileView() {
        const container = document.querySelector(".editor-container");
        const toggleBtn = document.getElementById("mobile-toggle-btn");
        const toggleText = document.getElementById("toggle-text");

        isMobileView = !isMobileView;

        if (isMobileView) {
          container.classList.add("mobile-view");
          toggleText.textContent = " Show Panels";
        } else {
          container.classList.remove("mobile-view");
          container.classList.toggle("mobile-panels-visible");
          if (container.classList.contains("mobile-panels-visible")) {
            toggleText.textContent = " Hide Panels";
          } else {
            toggleText.textContent = " Show Panels";
          }
        }
      }

      // Auto-detect mobile and set initial state
      document.addEventListener("DOMContentLoaded", () => {
        if (window.innerWidth <= 1024) {
          // Start in mobile view on small screens
          const toggleBtn = document.getElementById("mobile-toggle-btn");
          toggleBtn.style.display = "block";

          // Ensure panorama is visible at top on mobile
          ensurePanoramaVisible();
        }
      });

      // Function to ensure panorama is visible on mobile
      function ensurePanoramaVisible() {
        if (window.innerWidth <= 1024) {
          // Force scroll to absolute top
          document.documentElement.scrollTop = 0;
          document.body.scrollTop = 0;
          window.scrollTo(0, 0);

          // Force panorama viewer positioning
          const panoramaViewer = document.querySelector(".panorama-viewer");
          if (panoramaViewer) {
            // Force absolute positioning at top
            panoramaViewer.style.position = "absolute";
            panoramaViewer.style.top = "0px";
            panoramaViewer.style.left = "0px";
            panoramaViewer.style.width = "100%";
            panoramaViewer.style.zIndex = "10";
          }

          // Force A-Frame scene to resize properly on mobile
          setTimeout(() => {
            const scene = document.getElementById("panorama-scene");
            const canvas = scene?.querySelector("canvas");

            if (scene && canvas) {
              // Get the container height based on screen size
              const containerHeight =
                window.innerWidth <= 480 ? "35vh" : "40vh";

              // Force scene dimensions
              scene.style.height = containerHeight;
              scene.style.width = "100%";
              scene.style.display = "block";

              // Force canvas dimensions
              canvas.style.height = containerHeight;
              canvas.style.width = "100%";
              canvas.style.display = "block";
              canvas.style.position = "absolute";
              canvas.style.top = "0";
              canvas.style.left = "0";

              // Trigger A-Frame resize if available
              if (scene.resize) {
                scene.resize();
              }

              // Force canvas context resize
              const renderer = scene.renderer;
              if (renderer) {
                renderer.setSize(
                  panoramaViewer.clientWidth,
                  panoramaViewer.clientHeight
                );
              }
            }
          }, 300);
        }
      }

      // Handle window resize
      window.addEventListener("resize", () => {
        const toggleBtn = document.getElementById("mobile-toggle-btn");
        if (window.innerWidth <= 1024) {
          toggleBtn.style.display = "block";
          // Ensure panorama stays visible on resize
          setTimeout(() => ensurePanoramaVisible(), 100);
        } else {
          toggleBtn.style.display = "none";
          // Reset mobile classes on desktop
          document
            .querySelector(".editor-container")
            .classList.remove("mobile-view", "mobile-panels-visible");
          isMobileView = false;
        }
      });

      // Ensure panorama is visible when page loads
      window.addEventListener("load", () => {
        if (window.innerWidth <= 1024) {
          setTimeout(() => ensurePanoramaVisible(), 200);
        }
      });

      // Professional Mobile Interface Functions
      let mobileBottomSheetExpanded = false;
      let currentMobileTab = "editor";
      let selectedHotspotMobile = null;

      // Enhanced Mobile Bottom Sheet Control
      function toggleMobileBottomSheet() {
        const sheet = document.getElementById("mobile-bottom-sheet");
        const isExpanded = sheet.classList.contains("expanded");

        if (isExpanded) {
          sheet.classList.remove("expanded");
          mobileBottomSheetExpanded = false;
        } else {
          sheet.classList.add("expanded");
          mobileBottomSheetExpanded = true;
          // Show current tab content with animation
          setTimeout(() => {
            document
              .querySelector(`[data-tab="${currentMobileTab}"]`)
              .classList.add("active");
          }, 200);
        }
      }

      // Professional Tab Switching
      function switchMobileTab(tabName) {
        // Remove active class from all tabs and content
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        // Add active class to selected tab and content
        document
          .querySelector(`[data-tab="${tabName}"]`)
          .classList.add("active");
        document.getElementById(`${tabName}-tab`).classList.add("active");

        currentMobileTab = tabName;

        // Update content based on tab
        if (tabName === "hotspots") {
          updateMobileHotspotList();
        }
      }

      // Enhanced Icon Selection for Mobile
      function showIconSelectionMobile() {
        // Close bottom sheet first
        if (mobileBottomSheetExpanded) {
          toggleMobileBottomSheet();
        }

        // Go directly to animated icons manager instead of static icon selection
        editor.openAnimatedIconsManagerDirect();

        // Add mobile-specific enhancements for animated icons modal
        const modal = document.getElementById("animated-icons-modal");
        const panel = modal.querySelector(".icon-selection-panel");

        // Make it more mobile-friendly
        if (panel) {
          panel.style.maxHeight = "90vh";
          panel.style.maxWidth = "95vw";
        }
        panel.style.margin = "10px";

        // Add touch-friendly close gesture
        let startY = 0;
        panel.addEventListener("touchstart", (e) => {
          startY = e.touches[0].clientY;
        });

        panel.addEventListener("touchmove", (e) => {
          const currentY = e.touches[0].clientY;
          const diff = currentY - startY;

          if (diff > 100) {
            // Swipe down to close
            editor.closeIconSelection();
          }
        });
      }

      // Professional Status Management
      function showMobileStatus(message, type = "info", duration = 3000) {
        const indicator = document.getElementById("status-indicator");
        const text = document.getElementById("status-text");
        const icon = indicator.querySelector("i");

        // Update content
        text.textContent = message;

        // Update icon and style based on type
        indicator.className = `status-indicator ${type}`;

        switch (type) {
          case "success":
            icon.className = "fas fa-check-circle";
            break;
          case "error":
            icon.className = "fas fa-exclamation-triangle";
            break;
          case "warning":
            icon.className = "fas fa-exclamation-circle";
            break;
          default:
            icon.className = "fas fa-info-circle";
        }

        // Show with animation
        indicator.style.display = "flex";
        indicator.style.animation = "bounceIn 0.5s ease";

        // Hide after duration
        setTimeout(() => {
          indicator.style.animation = "fadeOut 0.3s ease";
          setTimeout(() => {
            indicator.style.display = "none";
          }, 300);
        }, duration);
      }

      // Enhanced Mobile Hotspot List
      function updateMobileHotspotList() {
        const container = document.getElementById("hotspot-list-mobile");

        // Check if container exists (might not be in desktop view)
        if (!container) {
          console.log(
            "Mobile hotspot list container not found - probably in desktop mode"
          );
          return;
        }

        if (!editor.hotspots || editor.hotspots.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.6);">
              <i class="fas fa-map-pin" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
              <p style="font-size: 16px; margin-bottom: 8px;">No hotspots yet</p>
              <p style="font-size: 14px;">Switch to Editor tab to add your first hotspot</p>
            </div>
          `;
          return;
        }

        container.innerHTML = "";

        editor.hotspots.forEach((hotspot, index) => {
          const card = document.createElement("div");
          card.className = "hotspot-card-mobile";
          if (
            selectedHotspotMobile &&
            selectedHotspotMobile.id === hotspot.id
          ) {
            card.classList.add("selected");
          }

          const typeColor = getHotspotTypeColor(hotspot.type);
          const typeIcon = getHotspotTypeIcon(hotspot.type);

          card.innerHTML = `
            <div class="hotspot-header-mobile">
              <h4 class="hotspot-title-mobile">
                <i class="${typeIcon}" style="margin-right: 8px; color: ${typeColor};"></i>
                ${hotspot.title || "Untitled Hotspot"}
              </h4>
              <div class="hotspot-type-badge" style="background: ${typeColor}20; color: ${typeColor}; border-color: ${typeColor}30;">
                ${hotspot.type}
              </div>
            </div>
            <div class="hotspot-description-mobile">
              ${hotspot.description || "No description"}
            </div>
            <div class="hotspot-actions-mobile">
              <button class="btn-mobile-secondary" onclick="selectHotspotMobile('${
                hotspot.id
              }')">
                <i class="fas fa-edit"></i>
                Edit
              </button>
              <button class="btn-mobile-secondary" onclick="focusHotspotMobile('${
                hotspot.id
              }')">
                <i class="fas fa-eye"></i>
                View
              </button>
              <button class="btn-mobile-secondary" onclick="deleteHotspotMobile('${
                hotspot.id
              }')">
                <i class="fas fa-trash"></i>
                Delete
              </button>
            </div>
          `;

          container.appendChild(card);
        });
      }

      // Helper Functions for Mobile UI
      function getHotspotTypeColor(type) {
        const colors = {
          info: "#04aa6d",
          navigation: "#ffa500",
          office: "#007bff",
          external: "#6f42c1",
        };
        return colors[type] || "#04aa6d";
      }

      function getHotspotTypeIcon(type) {
        const icons = {
          info: "fas fa-info-circle",
          navigation: "fas fa-route",
          office: "fas fa-building",
          external: "fas fa-external-link-alt",
        };
        return icons[type] || "fas fa-map-pin";
      }

      // Mobile Hotspot Management
      function selectHotspotMobile(hotspotId) {
        const hotspot = editor.hotspots.find((h) => h.id === hotspotId);
        if (!hotspot) return;

        selectedHotspotMobile = hotspot;

        // Switch to editor tab
        switchMobileTab("editor");

        // Populate form
        document.getElementById("hotspot-title-mobile").value =
          hotspot.title || "";
        document.getElementById("hotspot-description-mobile").value =
          hotspot.description || "";
        document.getElementById("hotspot-type-mobile").value =
          hotspot.type || "info";
        document.getElementById("hotspot-target-mobile").value =
          hotspot.target || "";

        // Show update actions
        document.getElementById("update-actions-mobile").style.display =
          "block";

        // Also select in main editor
        editor.selectHotspot(hotspot);

        showMobileStatus(`Selected: ${hotspot.title}`, "success");
      }

      function focusHotspotMobile(hotspotId) {
        const hotspot = editor.hotspots.find((h) => h.id === hotspotId);
        if (!hotspot) return;

        // Close bottom sheet to show panorama
        if (mobileBottomSheetExpanded) {
          toggleMobileBottomSheet();
        }

        // Focus camera on hotspot
        focusCameraOnHotspot(hotspot);

        showMobileStatus(`Viewing: ${hotspot.title}`, "info");
      }

      function deleteHotspotMobile(hotspotId) {
        const hotspot = editor.hotspots.find((h) => h.id === hotspotId);
        if (!hotspot) return;

        if (confirm(`Delete "${hotspot.title}"?`)) {
          // Use main editor's delete function
          editor.selectedHotspot = hotspot;
          editor.deleteSelectedHotspot();

          // Update mobile list
          updateMobileHotspotList();

          showMobileStatus("Hotspot deleted", "warning");
        }
      }

      // Mobile Form Actions
      function updateSelectedHotspotMobile() {
        if (!selectedHotspotMobile) return;

        // Update hotspot data from mobile form
        selectedHotspotMobile.title = document.getElementById(
          "hotspot-title-mobile"
        ).value;
        selectedHotspotMobile.description = document.getElementById(
          "hotspot-description-mobile"
        ).value;
        selectedHotspotMobile.type = document.getElementById(
          "hotspot-type-mobile"
        ).value;
        selectedHotspotMobile.target = document.getElementById(
          "hotspot-target-mobile"
        ).value;

        // Use main editor's update function
        editor.selectedHotspot = selectedHotspotMobile;
        editor.updateSelectedHotspot();

        // Clear selection
        selectedHotspotMobile = null;
        document.getElementById("update-actions-mobile").style.display = "none";

        // Update mobile list
        updateMobileHotspotList();

        showMobileStatus("Hotspot updated successfully", "success");
      }

      function deleteSelectedHotspotMobile() {
        if (!selectedHotspotMobile) return;

        if (confirm(`Delete "${selectedHotspotMobile.title}"?`)) {
          editor.selectedHotspot = selectedHotspotMobile;
          editor.deleteSelectedHotspot();

          selectedHotspotMobile = null;
          document.getElementById("update-actions-mobile").style.display =
            "none";

          updateMobileHotspotList();
          showMobileStatus("Hotspot deleted", "warning");
        }
      }

      // Professional Help System
      function showHelpOverlay() {
        document.getElementById("help-overlay").style.display = "flex";
        document.getElementById("help-overlay").style.animation =
          "fadeIn 0.3s ease";
      }

      function hideHelpOverlay() {
        const overlay = document.getElementById("help-overlay");
        overlay.style.animation = "fadeOut 0.3s ease";
        setTimeout(() => {
          overlay.style.display = "none";
        }, 300);
      }

      // Enhanced Panorama Controls
      function resetPanoramaView() {
        const camera = document.querySelector("[camera]");
        if (camera) {
          camera.setAttribute("rotation", "0 0 0");
          camera.setAttribute("position", "0 0 0");
          showMobileStatus("View reset to center", "info");
        }
      }

      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().then(() => {
            showMobileStatus("Entered fullscreen mode", "info");
          });
        } else {
          document.exitFullscreen().then(() => {
            showMobileStatus("Exited fullscreen mode", "info");
          });
        }
      }

      function confirmCloseEditor() {
        if (
          confirm("Close panorama editor? Any unsaved changes will be lost.")
        ) {
          if (window.opener) {
            window.opener.postMessage({ type: "editorClosed" }, "*");
          }
          window.close();
        }
      }

      // Enhanced Camera Focus Function
      function focusCameraOnHotspot(hotspot) {
        const camera = document.querySelector("[camera]");
        if (!camera || !hotspot.position) return;

        // Calculate look direction towards hotspot
        const pos = hotspot.position;
        const distance = Math.sqrt(
          pos.x * pos.x + pos.y * pos.y + pos.z * pos.z
        );

        // Calculate rotation to look at hotspot
        const rotationY = Math.atan2(pos.x, -pos.z) * (180 / Math.PI);
        const rotationX = Math.asin(pos.y / distance) * (180 / Math.PI);

        // Smoothly animate camera rotation
        camera.setAttribute(
          "animation",
          `property: rotation; to: ${rotationX} ${rotationY} 0; dur: 1000; easing: easeOutQuad`
        );
      }

      // Form Synchronization
      function setupFormSync() {
        const pairs = [
          ["hotspot-title", "hotspot-title-mobile"],
          ["hotspot-description", "hotspot-description-mobile"],
          ["hotspot-type", "hotspot-type-mobile"],
          ["hotspot-target", "hotspot-target-mobile"],
        ];

        pairs.forEach(([desktop, mobile]) => {
          const desktopEl = document.getElementById(desktop);
          const mobileEl = document.getElementById(mobile);

          if (desktopEl && mobileEl) {
            desktopEl.addEventListener("input", () => {
              mobileEl.value = desktopEl.value;
            });

            mobileEl.addEventListener("input", () => {
              desktopEl.value = mobileEl.value;
            });
          }
        });
      }

      // Touch Gestures for Mobile
      function setupMobileTouchGestures() {
        const panoramaViewer = document.querySelector(".panorama-viewer");
        if (!panoramaViewer) return;

        let touchStartY = 0;

        panoramaViewer.addEventListener("touchstart", (e) => {
          touchStartY = e.touches[0].clientY;
        });

        panoramaViewer.addEventListener("touchend", (e) => {
          const touchEndY = e.changedTouches[0].clientY;
          const diff = touchEndY - touchStartY;

          // Swipe up to open bottom sheet
          if (diff < -50 && !mobileBottomSheetExpanded) {
            toggleMobileBottomSheet();
          }
          // Swipe down to close bottom sheet
          else if (diff > 50 && mobileBottomSheetExpanded) {
            toggleMobileBottomSheet();
          }
        });
      }

      // Initialize Mobile Interface
      document.addEventListener("DOMContentLoaded", () => {
        if (window.innerWidth <= 1024) {
          // Initialize mobile interface
          updateMobileHotspotList();

          // Setup form synchronization between desktop and mobile forms
          setupFormSync();

          // Setup touch gestures
          setupMobileTouchGestures();
        }
      });

      // Override editor methods for mobile integration
      window.addEventListener("load", () => {
        if (typeof editor !== "undefined") {
          const originalUpdateHotspotList = editor.updateHotspotList;
          editor.updateHotspotList = function () {
            originalUpdateHotspotList.call(this);
            if (window.innerWidth <= 1024) {
              updateMobileHotspotList();
            }
          };

          const originalSaveHotspots = editor.saveHotspots;
          editor.saveHotspots = function () {
            // Show loading for mobile
            if (window.innerWidth <= 1024) {
              document.getElementById("loading-overlay-mobile").style.display =
                "flex";
            }

            const result = originalSaveHotspots.call(this);

            // Hide loading and show status
            setTimeout(() => {
              if (window.innerWidth <= 1024) {
                document.getElementById(
                  "loading-overlay-mobile"
                ).style.display = "none";
                showMobileStatus("Hotspots saved successfully!", "success");
              }
            }, 1000);

            return result;
          };
        }
      });

      // ===== ANIMATED HOTSPOT ICONS MANAGER =====

      // Global variables for animated icons
      let animatedIcons = [];
      let currentAnimatedCategory = "all";

      // Initialize animated icons manager
      function initializeAnimatedIconsManager() {
        setupAnimatedIconsEventListeners();
        loadAnimatedIcons();
      }

      function setupAnimatedIconsEventListeners() {
        // Main button to open animated icons manager
        document
          .getElementById("manage-animated-icons-btn")
          .addEventListener("click", openAnimatedIconsManager);

        // Close modal buttons
        document
          .getElementById("close-animated-icons-modal")
          .addEventListener("click", closeAnimatedIconsManager);
        document
          .getElementById("cancel-edit-animated-icon")
          .addEventListener("click", closeEditAnimatedIconModal);

        // Tab switching
        document.querySelectorAll(".animated-tab-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            switchAnimatedIconTab(this.dataset.tab);
          });
        });

        // Category filtering
        document.querySelectorAll(".animated-filter-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            filterAnimatedIconsByCategory(this.dataset.category);
          });
        });

        // Upload form
        document
          .getElementById("animated-icon-upload-form")
          .addEventListener("submit", handleAnimatedIconUpload);

        // Edit form
        document
          .getElementById("edit-animated-icon-form")
          .addEventListener("submit", handleAnimatedIconEdit);

        // File input change
        document
          .getElementById("animated-icon-file")
          .addEventListener("change", handleAnimatedFilePreview);

        // File drop zone
        const dropZone = document.getElementById("animated-file-drop-zone");
        dropZone.addEventListener("dragover", handleAnimatedFileDragOver);
        dropZone.addEventListener("dragleave", handleAnimatedFileDragLeave);
        dropZone.addEventListener("drop", handleAnimatedFileDrop);
      }

      function openAnimatedIconsManager() {
        document.getElementById("animated-icons-modal").style.display = "flex";
        // Directly load video hotspots (skip GIF manager)
        loadVideoHotspots();
      }

      function closeAnimatedIconsManager() {
        document.getElementById("animated-icons-modal").style.display = "none";
        // Don't show static icon selection - we're bypassing it completely
      }

      function closeEditAnimatedIconModal() {
        document.getElementById("edit-animated-icon-modal").style.display =
          "none";
      }

      function switchAnimatedIconTab(tabName) {
        // Only video tab is available now
        loadVideoHotspots();
      }

      function handleAnimatedIconUpload(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        formData.append("action", "upload");

        showAnimatedMessage("Uploading icon...", "warning");

        fetch("animated_hotspot_manager.php", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showAnimatedMessage("Icon uploaded successfully!", "success");
              event.target.reset();
              document.getElementById("animated-file-preview").style.display =
                "none";

              // Switch to manage tab and reload icons
              switchAnimatedIconTab("manage");
              loadAnimatedIcons();
            } else {
              showAnimatedMessage("Error: " + data.error, "error");
            }
          })
          .catch((error) => {
            console.error("Upload error:", error);
            showAnimatedMessage("Upload failed. Please try again.", "error");
          });
      }

      function handleAnimatedFilePreview(event) {
        const file = event.target.files[0];
        const preview = document.getElementById("animated-file-preview");
        const previewImage = document.getElementById("animated-preview-image");
        const fileInfo = document.getElementById("animated-file-info");

        if (file) {
          if (file.type !== "image/gif") {
            showAnimatedMessage("Please select a GIF file", "error");
            event.target.value = "";
            preview.style.display = "none";
            return;
          }

          if (file.size > 2 * 1024 * 1024) {
            showAnimatedMessage("File size must be less than 2MB", "error");
            event.target.value = "";
            preview.style.display = "none";
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            previewImage.src = e.target.result;
            fileInfo.textContent = `${file.name} (${formatFileSize(
              file.size
            )})`;
            preview.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          preview.style.display = "none";
        }
      }

      function handleAnimatedFileDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add("dragover");
      }

      function handleAnimatedFileDragLeave(event) {
        event.currentTarget.classList.remove("dragover");
      }

      function handleAnimatedFileDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove("dragover");

        const files = event.dataTransfer.files;
        if (files.length > 0) {
          document.getElementById("animated-icon-file").files = files;
          handleAnimatedFilePreview({ target: { files: files } });
        }
      }

      function loadAnimatedIcons(category = "all") {
        const container = document.getElementById("animated-icons-grid");
        container.innerHTML =
          '<div style="text-align: center; color: #888; grid-column: 1/-1; padding: 50px;"><i class="fas fa-spinner fa-spin" style="font-size: 30px; margin-bottom: 10px;"></i><div>Loading animated icons...</div></div>';

        const url = `animated_hotspot_manager.php?action=list${
          category !== "all" ? "&category=" + category : ""
        }`;

        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              animatedIcons = data.icons;
              displayAnimatedIcons(animatedIcons);
            } else {
              container.innerHTML =
                '<div style="text-align: center; color: #dc3545; grid-column: 1/-1; padding: 50px;">Error loading icons: ' +
                data.error +
                "</div>";
            }
          })
          .catch((error) => {
            console.error("Load error:", error);
            container.innerHTML =
              '<div style="text-align: center; color: #dc3545; grid-column: 1/-1; padding: 50px;">Failed to load icons. Please try again.</div>';
          });
      }

      function displayAnimatedIcons(iconsToShow) {
        const container = document.getElementById("animated-icons-grid");

        if (iconsToShow.length === 0) {
          container.innerHTML =
            '<div style="text-align: center; color: #888; grid-column: 1/-1; padding: 50px;">No icons found for the selected category.</div>';
          return;
        }

        container.innerHTML = "";

        // Helper to safely derive a display name for icons (fallback to filename or id)
        function getAnimatedIconDisplayName(icon) {
          if (!icon) return '';
          if (icon.icon_name && icon.icon_name.trim().length) return icon.icon_name;
          if (icon.name && icon.name.trim().length) return icon.name;
          if (icon.icon_file_path) {
            try {
              const parts = icon.icon_file_path.split('/');
              return parts[parts.length - 1] || `GIF ${icon.id}`;
            } catch (e) {
              return `GIF ${icon.id}`;
            }
          }
          return `GIF ${icon.id}`;
        }

        iconsToShow.forEach((icon) => {
          const iconCard = document.createElement("div");
          iconCard.className = "animated-icon-card";
          iconCard.innerHTML = `
            <div class="animated-icon-preview">
              <img src="${icon.icon_file_path}" alt="${getAnimatedIconDisplayName(icon)}" onerror="this.style.display='none'">
            </div>
            <div class="animated-icon-name">${getAnimatedIconDisplayName(icon)}</div>
            <div class="animated-icon-category">${icon.icon_category}</div>
            <div class="animated-icon-actions">
              <button class="btn btn-secondary" onclick="editAnimatedIcon(${icon.id})">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="btn" onclick="useAnimatedIcon(${icon.id})" style="background: #28a745;">
                <i class="fas fa-hand-pointer"></i> Use
              </button>
              <button class="btn btn-danger" onclick="deleteAnimatedIcon(${icon.id}, '${getAnimatedIconDisplayName(icon)}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          `;
          container.appendChild(iconCard);
        });
      }

      function filterAnimatedIconsByCategory(category) {
        currentAnimatedCategory = category;

        // Update active button
        document.querySelectorAll(".animated-filter-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document
          .querySelector(`[data-category="${category}"]`)
          .classList.add("active");

        if (category === "all") {
          displayAnimatedIcons(animatedIcons);
        } else {
          const filteredIcons = animatedIcons.filter(
            (icon) => icon.icon_category === category
          );
          displayAnimatedIcons(filteredIcons);
        }
      }

      function useAnimatedIcon(iconId) {
        const icon = animatedIcons.find((i) => i.id == iconId);
        if (!icon) return;

        // Close the animated icons modal
        closeAnimatedIconsManager();

        // Preload this specific animated asset
        const scene = document.getElementById("panorama-scene");
        const system = scene?.systems["animated-hotspot-manager"];
        if (system) {
          system.preloadAnimatedAssets([
            {
              id: icon.id,
              src: icon.icon_file_path,
            },
          ]);
        }

        // Update the dragging icon to show the animated GIF preview
        const draggingIcon = document.getElementById("dragging-icon");
        draggingIcon.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center;">
            <img src="${icon.icon_file_path}" 
                 style="width: 40px; height: 40px; border-radius: 8px; border: 2px solid #04aa6d; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
            <span style="font-size: 10px; color: #04aa6d; font-weight: bold; margin-top: 4px;">${getAnimatedIconDisplayName(icon)}</span>
          </div>
        `;

        // Store the selected animated icon data for use when creating hotspot
        window.selectedAnimatedIcon = {
          id: icon.id,
          name: getAnimatedIconDisplayName(icon),
          path: icon.icon_file_path,
          icon_file_path: icon.icon_file_path,
          icon_name: getAnimatedIconDisplayName(icon),
          category: icon.icon_category,
        };

        showAnimatedMessage(
          ` Selected "${getAnimatedIconDisplayName(icon)}" - Click anywhere on the panorama to place animated hotspot`,
          "success"
        );

        // Enable adding mode for placing the hotspot
        if (typeof editor !== "undefined") {
          console.log(" Setting animated hotspot adding mode");
          editor.isAddingMode = true;
          editor.selectedAnimatedIcon = window.selectedAnimatedIcon;

          // Update the button to show active state
          const btn = document.getElementById("add-hotspot-btn");
          if (btn) {
            btn.textContent = " Click panorama to place animated hotspot";
            btn.style.background = "#ff6b6b";
            btn.style.animation = "pulse 2s infinite";
          }

          // Show instructions
          const instructions = document.getElementById("drag-instructions");
          if (instructions) {
            instructions.textContent =
              " Click anywhere on the panorama to place your animated hotspot";
            instructions.style.display = "block";
          }
        } else {
          console.error("Editor is undefined!");
        }
      }

      function editAnimatedIcon(iconId) {
        const icon = animatedIcons.find((i) => i.id == iconId);
        if (!icon) return;

        document.getElementById("edit-animated-icon-id").value = icon.id;
        document.getElementById("edit-animated-icon-name").value =
          icon.icon_name;
        document.getElementById("edit-animated-icon-description").value =
          icon.icon_description || "";
        document.getElementById("edit-animated-icon-category").value =
          icon.icon_category;

        document.getElementById("edit-animated-icon-modal").style.display =
          "flex";
      }

      function handleAnimatedIconEdit(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        formData.append("action", "update");

        fetch("animated_hotspot_manager.php", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showAnimatedMessage("Icon updated successfully!", "success");
              closeEditAnimatedIconModal();
              loadAnimatedIcons();
            } else {
              showAnimatedMessage("Error: " + data.error, "error");
            }
          })
          .catch((error) => {
            console.error("Update error:", error);
            showAnimatedMessage("Update failed. Please try again.", "error");
          });
      }

      function deleteAnimatedIcon(iconId, iconName) {
        if (
          !confirm(`Are you sure you want to delete the icon "${iconName}"?`)
        ) {
          return;
        }

        const formData = new FormData();
        formData.append("action", "delete");
        formData.append("icon_id", iconId);

        fetch("animated_hotspot_manager.php", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showAnimatedMessage("Icon deleted successfully!", "success");
              loadAnimatedIcons();
            } else {
              showAnimatedMessage("Error: " + data.error, "error");
            }
          })
          .catch((error) => {
            console.error("Delete error:", error);
            showAnimatedMessage("Delete failed. Please try again.", "error");
          });
      }

      function showAnimatedMessage(text, type = "success") {
        const container = document.getElementById("animated-icons-messages");
        const message = document.createElement("div");
        message.className = `animated-message ${type}`;
        message.textContent = text;

        container.appendChild(message);

        // Trigger show animation
        setTimeout(() => message.classList.add("show"), 100);

        // Auto remove after 5 seconds
        setTimeout(() => {
          message.classList.remove("show");
          setTimeout(() => {
            if (message.parentNode) {
              message.parentNode.removeChild(message);
            }
          }, 400);
        }, 5000);
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // Helper to safely derive a display name for icons (fallback to filename or id)
      function getAnimatedIconDisplayName(icon) {
        if (!icon) return '';
        if (icon.icon_name && icon.icon_name.trim().length) return icon.icon_name;
        if (icon.name && icon.name.trim().length) return icon.name;
        if (icon.icon_file_path) {
          try {
            const parts = icon.icon_file_path.split('/');
            return parts[parts.length - 1] || `GIF ${icon.id}`;
          } catch (e) {
            return `GIF ${icon.id}`;
          }
        }
        return `GIF ${icon.id}`;
      }

      // Normalize asset URL and add cache-buster - available globally
      function normalizeAssetUrl(assetUrl) {
        if (!assetUrl) return assetUrl;
        let path = String(assetUrl).replace(/\\/g, '/');

        // If it's a filesystem path, extract basename
        if (/^[a-zA-Z]:\//.test(path) || path.includes('/var/www') || path.includes('htdocs')) {
          path = path.split('/').pop();
        }

        if (path.startsWith('http') || path.startsWith('/')) {
          return path + (path.includes('?') ? '&' : '?') + 'v=' + Date.now();
        }

        return `animated_hotspot_icons/${path.split('/').pop()}?v=${Date.now()}`;
      }

      // Initialize animated icons manager when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initializeAnimatedIconsManager();
      });

      // When the editor is created, attach helper to it if possible
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof editor !== 'undefined' && editor) {
          try {
            editor.normalizeAssetUrl = normalizeAssetUrl;
          } catch (e) {
            console.warn('Could not attach normalizeAssetUrl to editor', e);
          }
        }
      });

      // Close modals when clicking outside
      document
        .getElementById("animated-icons-modal")
        .addEventListener("click", function (event) {
          if (event.target === this) {
            closeAnimatedIconsManager();
          }
        });

      document
        .getElementById("edit-animated-icon-modal")
        .addEventListener("click", function (event) {
          if (event.target === this) {
            closeEditAnimatedIconModal();
          }
        });

      // ===== VIDEO HOTSPOTS MANAGER =====

      function initializeVideoHotspots() {
        // Open video manager button
        document
          .getElementById("open-video-manager-btn")
          .addEventListener("click", function () {
            window.open(
              "video_hotspot_uploader.html",
              "_blank",
              "width=1200,height=800"
            );
          });

        // Refresh videos button
        document
          .getElementById("refresh-videos-btn")
          .addEventListener("click", function () {
            loadVideoHotspots();
          });
      }

      function loadVideoHotspots() {
        const grid = document.getElementById("video-hotspots-grid");

        fetch("video_hotspot_manager.php?action=list")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              renderVideoHotspots(data.videos);
            } else {
              grid.innerHTML = `
                <div style="text-align: center; color: #f44336; grid-column: 1/-1; padding: 30px;">
                  <i class="fas fa-exclamation-triangle" style="font-size: 30px; margin-bottom: 10px;"></i>
                  <div>Error loading videos: ${data.error}</div>
                </div>
              `;
            }
          })
          .catch((error) => {
            console.error("Error loading video hotspots:", error);
            grid.innerHTML = `
              <div style="text-align: center; color: #f44336; grid-column: 1/-1; padding: 30px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 30px; margin-bottom: 10px;"></i>
                <div>Failed to load video hotspots</div>
              </div>
            `;
          });
      }

      function renderVideoHotspots(videos) {
        const grid = document.getElementById("video-hotspots-grid");

        if (videos.length === 0) {
          grid.innerHTML = `
            <div style="text-align: center; color: #888; grid-column: 1/-1; padding: 40px;">
              <i class="fas fa-video" style="font-size: 40px; margin-bottom: 15px; color: #555;"></i>
              <div style="margin-bottom: 10px;">No video hotspots available</div>
              <small>Upload video files using the Video Manager</small>
            </div>
          `;
          return;
        }

        grid.innerHTML = videos
          .map(
            (video) => `
          <div class="video-hotspot-item" 
               style="
                 background: rgba(255,255,255,0.05);
                 border: 1px solid #555;
                 border-radius: 8px;
                 overflow: hidden;
                 cursor: pointer;
                 transition: all 0.3s;
               "
               onclick="selectVideoHotspot(${JSON.stringify(video).replace(
                 /"/g,
                 "&quot;"
               )})">
            <div style="position: relative;">
              <video 
                style="width: 100%; height: 120px; object-fit: cover; background: #000;" 
                muted>
                <source src="${video.url}" type="video/mp4">
              </video>
              <div style="
                position: absolute;
                top: 5px;
                right: 5px;
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 11px;
              ">
                ${video.duration ? video.duration + "s" : "Video"}
              </div>
            </div>
            <div style="padding: 10px;">
              <div style="font-weight: bold; color: white; margin-bottom: 5px; font-size: 14px;">
                ${video.name}
              </div>
              <div style="font-size: 12px; color: #888; margin-bottom: 8px;">
                ${video.file_size_mb} MB
                ${
                  video.width && video.height
                    ? `  ${video.width}${video.height}`
                    : ""
                }
              </div>
              <button class="btn btn-primary" style="
                width: 100%;
                padding: 6px 12px;
                font-size: 12px;
                background: #04aa6d;
                border: none;
              ">
                <i class="fas fa-plus"></i> Use as Hotspot
              </button>
            </div>
          </div>
        `
          )
          .join("");

        // Add hover effects to video previews
        grid.querySelectorAll("video").forEach((video) => {
          const item = video.closest(".video-hotspot-item");
          item.addEventListener("mouseenter", () => {
            video.play().catch(() => {}); // Play video on hover
            item.style.transform = "scale(1.02)";
            item.style.borderColor = "#04aa6d";
          });
          item.addEventListener("mouseleave", () => {
            video.pause(); // Pause video when not hovering
            item.style.transform = "scale(1)";
            item.style.borderColor = "#555";
          });
        });
      }

      function selectVideoHotspot(video) {
        console.log(" Selected video hotspot:", video);

        // Store selected video globally for hotspot creation
        window.selectedVideoHotspot = video;
        window.selectedAnimatedIcon = null; // Clear GIF selection

        // Update UI feedback
        document.querySelectorAll(".video-hotspot-item").forEach((item) => {
          item.style.borderColor = "#555";
        });

        event.currentTarget.style.borderColor = "#04aa6d";

        // Close modal and start placement mode
        closeAnimatedIconsManager();

        // Enable hotspot placement mode
        const editor = window.panoramaEditor;
        console.log(" Editor found:", !!editor);
        if (editor) {
          // Set the adding mode (this is what the click handler checks)
          editor.isDraggingIcon = true;
          editor.isAddingMode = true;
          console.log(" Set isAddingMode to:", editor.isAddingMode);

          editor.selectedIcon = {
            icon: "fas fa-video",
            name: video.name,
            isVideo: true,
            videoData: video,
          };

          // Show drag instructions
          const instructions = document.getElementById("drag-instructions");
          if (instructions) {
            instructions.style.display = "block";
            instructions.innerHTML = `
              <div style="background: rgba(4, 170, 109, 0.9); color: white; padding: 15px; border-radius: 8px;">
                <i class="fas fa-video"></i> Click anywhere on the panorama to place "${video.name}" video hotspot
                <div style="margin-top: 8px; font-size: 12px; opacity: 0.9;">
                  Video will play automatically and loop continuously
                </div>
              </div>
            `;
          }

          // Show dragging icon
          const dragIcon = document.getElementById("dragging-icon");
          if (dragIcon) {
            dragIcon.innerHTML = `<i class="fas fa-video"></i>`;
            dragIcon.style.display = "block";
          }
        }

        console.log(
          " Video hotspot selection complete. Click on panorama to place."
        );
      }

      // Initialize video hotspots manager
      document.addEventListener("DOMContentLoaded", function () {
        initializeVideoHotspots();
      });

      // ===== END ANIMATED HOTSPOT ICONS MANAGER =====
    </script>
  </body>
</html>
