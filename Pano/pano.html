<html>
  <head>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-mouse-wheel-component/dist/aframe-mouse-wheel-component.min.js"></script>
    <script src="https://unpkg.com/aframe-touch-zoom-component/dist/aframe-touch-zoom-component.min.js"></script>
    <script src="pano.js"></script>
  </head>
  <body>
    <a-scene mouse-wheel="fovMin: 30; fovMax: 100;" touch-zoom>
      <!-- Camera and mouse cursor for desktop/mobile interaction -->
      <a-entity camera look-controls>
        <a-entity cursor="rayOrigin: mouse"></a-entity>
      </a-entity>
      <!-- Sky will be set dynamically -->
      <a-sky id="panorama-sky" src=""></a-sky>
      <!-- Hotspots will be added dynamically -->
    </a-scene>
    
    <!-- Fallback overlay when no panorama is available -->
    <div id="pano-fallback-overlay" style="display:none; position:fixed; inset:0; z-index:1000; background:#000; color:#fff; align-items:center; justify-content:center; text-align:center;">
      <div style="padding:20px; max-width:90vw;">
        <h2 style="font-family:Arial, Helvetica, sans-serif; font-size:18px; margin:0;">No available panorama for this section :(</h2>
      </div>
    </div>
    
    <script>
      // Get URL parameters
      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          pathId: params.get('path_id') || 'path1',
          pointIndex: params.get('point_index') || '5',
          floorNumber: params.get('floor_number') || '1'
        };
      }
      
      // Load panorama data and set up scene
      async function loadPanoramaData() {
        const params = getUrlParams();
        
        try {
          const response = await fetch(`../panorama_api.php?action=get_for_point&path_id=${params.pathId}&point_index=${params.pointIndex}&floor_number=${params.floorNumber}`);
          const data = await response.json();
          
          const sky = document.getElementById('panorama-sky');
          const fallbackOverlay = document.getElementById('pano-fallback-overlay');

          if (data.success && data.panorama) {
            // Hide fallback overlay if it was showing
            if (fallbackOverlay) {
              fallbackOverlay.style.display = 'none';
            }

            // Set the main panorama image
            sky.setAttribute('src', '../' + data.image_url);

            // Load related panoramas for hotspots
            await loadHotspots(params.floorNumber);

            console.log('Panorama loaded:', data.panorama.title || 'Unnamed');
          } else {
            console.error('Failed to load panorama:', data.error);
            // No panorama available for this point: show black-screen overlay with message
            if (fallbackOverlay) {
              fallbackOverlay.style.display = 'flex';
            } else {
              // As a safety, set sky to a solid black texture by using a tiny 1x1 black data URI
              sky.setAttribute('src', 'data:image/svg+xml;charset=utf-8,%3Csvg xmlns="http://www.w3.org/2000/svg" width="1" height="1"%3E%3Crect width="1" height="1" fill="%23000"/%3E%3C/svg%3E');
            }
          }
        } catch (error) {
          console.error('Error loading panorama:', error);
          // Fallback to default image
          document.getElementById('panorama-sky').setAttribute('src', '62b5213f-4e9b-4c20-938d-cd121e77fa68.jpg');
        }
      }
      
      // Load hotspots for navigation between panoramas
      async function loadHotspots(floorNumber) {
        try {
          const response = await fetch(`../panorama_api.php?action=list&floor_number=${floorNumber}`);
          const data = await response.json();
          
          if (data.success && data.panoramas) {
            const scene = document.querySelector('a-scene');
            
            // Create hotspots for each available panorama (limit to avoid clutter)
            data.panoramas.slice(0, 3).forEach((panorama, index) => {
              const hotspot = document.createElement('a-entity');
              hotspot.setAttribute('class', 'hotspot');
              hotspot.setAttribute('geometry', 'primitive: sphere; radius: 0.3');
              hotspot.setAttribute('material', 'color: #ff6b35; opacity: 0.8');
              
              // Position hotspots around the scene
              const angle = (index * 120) * (Math.PI / 180); // 120 degrees apart
              const radius = 4;
              const x = Math.cos(angle) * radius;
              const z = Math.sin(angle) * radius;
              hotspot.setAttribute('position', `${x} 0 ${z}`);
              
              // Add hover effects
              hotspot.setAttribute('event-set__enter', '_event: mouseenter; material.color: yellow; scale: 1.2 1.2 1.2');
              hotspot.setAttribute('event-set__leave', '_event: mouseleave; material.color: #ff6b35; scale: 1 1 1');
              
              // Add click listener to navigate to panorama
              hotspot.addEventListener('click', () => {
                const newUrl = `pano.html?path_id=${panorama.path_id}&point_index=${panorama.point_index}&floor_number=${panorama.floor_number}`;
                window.location.href = newUrl;
              });
              
              scene.appendChild(hotspot);
            });
          }
        } catch (error) {
          console.error('Error loading hotspots:', error);
        }
      }
      
      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        loadPanoramaData();
      });
    </script>
  </body>
</html>